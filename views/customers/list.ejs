<%- include('../partials/head', { title: 'إدارة العملاء' }) %>
  <%- include('../partials/sidebar', { adminUsername }) %>

    <style>
      .stats-icon-box {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
      }

      .table-premium th {
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        padding-top: 1rem;
        padding-bottom: 1rem;
      }

      .avatar-md {
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        border-radius: 50%;
      }

      .hover-bg-light:hover {
        background-color: #f8f9fa !important;
      }

      .badge-soft {
        padding: 0.35rem 0.65rem;
        border-radius: 6px;
        font-weight: 600;
      }
    </style>

    <div class="container-fluid py-4 px-4 pb-5">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <div class="d-flex align-items-center gap-3">
          <div
            class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center shadow-sm"
            style="width: 50px; height: 50px;">
            <i class="bi bi-people-fill fs-3"></i>
          </div>
          <div>
            <h4 class="fw-bold m-0 text-dark">دليل وسجل العملاء</h4>
            <p class="text-muted small mt-1 mb-0">إدارة قاعدة بيانات المستهلكين المسجلين، وأرقام هواتفهم، وعناوين الشحن
              الخاصة بهم.</p>
          </div>
        </div>
        <div>
          <button type="button" class="btn btn-primary px-4 shadow-sm fw-bold" data-bs-toggle="collapse"
            data-bs-target="#addCustomerCollapse" aria-expanded="false" aria-controls="addCustomerCollapse">
            <i class="bi bi-person-plus-fill ms-1"></i> تسجيل عميل جديد
          </button>
        </div>
      </div>

      <!-- Quick Add Form -->
      <div class="collapse mb-4" id="addCustomerCollapse">
        <div class="card border-0 shadow-sm border-start border-primary border-4 rounded-4">
          <div class="card-body p-4">
            <h6 class="fw-bold mb-4 text-dark d-flex align-items-center"><i
                class="bi bi-person-lines-fill text-primary me-2"></i> نموذج تسجيل مبدئي لعميل جديد</h6>
            <form method="post" action="/admin/customers" class="row g-3">
              <div class="col-md-3">
                <label class="form-label small fw-bold text-muted">اسم العميل بالكامل <span
                    class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text bg-light text-muted border-end-0"><i class="bi bi-person"></i></span>
                  <input type="text" name="name" class="form-control border-start-0 ps-0 text-dark fw-bold"
                    placeholder="الاسم الرباعي أو الثلاثي" required>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label small fw-bold text-muted">الهاتف الأساسي</label>
                <div class="input-group">
                  <span class="input-group-text bg-light text-muted border-end-0" dir="ltr">+218</span>
                  <input type="text" name="phone" class="form-control border-start-0 ps-0 fw-bold"
                    placeholder="09X XXX XXXX">
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label small fw-bold text-muted">البريد الإلكتروني (اختياري)</label>
                <div class="input-group">
                  <span class="input-group-text bg-light text-muted border-end-0"><i class="bi bi-envelope"></i></span>
                  <input type="email" name="email" class="form-control border-start-0 ps-0"
                    placeholder="mail@example.com">
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label small fw-bold text-muted">منطقة التوصيل المعتادة</label>
                <div class="input-group">
                  <span class="input-group-text bg-light text-muted border-end-0"><i class="bi bi-geo-alt"></i></span>
                  <input type="text" name="address" class="form-control border-start-0 ps-0"
                    placeholder="المدينة، الشارع، المعلم">
                </div>
              </div>
              <div class="col-12 mt-4 text-end">
                <button type="button" class="btn btn-light fw-bold px-4 me-2" data-bs-toggle="collapse"
                  data-bs-target="#addCustomerCollapse">تراجع وإلغاء</button>
                <button type="submit" class="btn btn-primary fw-bold px-5 shadow-sm"><i
                    class="bi bi-check-circle me-1"></i> حفظ وتأكيد إدراج العميل</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Customers Table Premium Container -->
      <div class="card border-0 shadow-sm overflow-hidden rounded-4 border-top border-info border-3">

        <!-- Table Toolbar -->
        <div class="card-header bg-white py-3 border-bottom d-flex align-items-center justify-content-between">
          <h6 class="fw-bold m-0 text-dark">
            <i class="bi bi-list-columns-reverse text-info ms-1"></i> قائمة البيانات الحالية لجميع المشتركين
          </h6>
          <span
            class="badge bg-light text-dark border border-secondary border-opacity-25 px-3 py-2 rounded-pill fw-bold shadow-sm">
            مجموع المشتركين: <%= customers.length %> عميل
          </span>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 table-premium">
            <thead class="bg-light bg-opacity-75">
              <tr>
                <th class="ps-4">بيانات هوية العميل</th>
                <th class="text-center">وسائل التواصل (الرئيسية)</th>
                <th class="text-center">وسائل التواصل (البديلة)</th>
                <th class="text-center">العنوان والموقع الجغرافي</th>
                <th class="text-end pe-4" style="width: 140px;">الضبط والإدارة</th>
              </tr>
            </thead>
            <tbody>
              <% customers.forEach(function(c) { %>
                <tr>
                  <td class="ps-4 py-3">
                    <div class="d-flex align-items-center gap-3">
                      <div class="avatar-md bg-light text-info border border-info border-opacity-25 shadow-sm">
                        <%= (c.name && c.name.length> 0) ? c.name.charAt(0).toUpperCase() : 'C' %>
                      </div>
                      <div>
                        <span class="fw-bold text-dark d-block mb-1" style="font-size: 0.95rem;">
                          <%= c.name %>
                        </span>
                        <small
                          class="badge bg-light text-muted border text-opacity-75 fw-normal d-inline-flex align-items-center py-1">
                          <i class="bi bi-calendar-check me-1"></i>
                          تم التسجيل في: <%= new Date(c.created_at || Date.now()).toLocaleDateString('ar-LY') %>
                        </small>
                      </div>
                    </div>
                  </td>
                  <td class="text-center">
                    <% if (c.phone) { %>
                      <a href="tel:<%= c.phone %>"
                        class="btn btn-sm btn-light border shadow-sm text-dark hover-bg-light fw-bold font-monospace d-inline-flex align-items-center gap-2">
                        <i class="bi bi-telephone text-primary"></i> <span dir="ltr">
                          <%= c.phone %>
                        </span>
                      </a>
                      <% } else { %>
                        <span class="badge bg-light text-muted border fw-normal"><i
                            class="bi bi-phone-vibrate opacity-50 me-1"></i> لا يوجد رقم</span>
                        <% } %>
                  </td>
                  <td class="text-center">
                    <% if (c.email) { %>
                      <a href="mailto:<%= c.email %>" class="text-decoration-none d-inline-block text-truncate"
                        style="max-width: 150px;" title="<%= c.email %>">
                        <span
                          class="badge bg-light text-dark border d-inline-flex align-items-center py-2 px-2 gap-1 text-lowercase">
                          <i class="bi bi-envelope text-info"></i>
                          <%= c.email %>
                        </span>
                      </a>
                      <% } else { %>
                        <span class="text-muted small italic opacity-50">— لم يحدد —</span>
                        <% } %>
                  </td>
                  <td class="text-center">
                    <% if (c.address) { %>
                      <span class="text-dark small d-inline-block text-truncate" style="max-width: 200px;"
                        title="<%= c.address %>">
                        <i class="bi bi-geo-alt-fill text-danger opacity-75"></i>
                        <%= c.address %>
                      </span>
                      <% } else { %>
                        <span class="text-muted small italic opacity-50">—</span>
                        <% } %>
                  </td>
                  <td class="text-end pe-4">
                    <div class="d-flex justify-content-end gap-2">
                      <button type="button" class="btn btn-light btn-sm rounded-circle border shadow-sm"
                        data-bs-toggle="modal" data-bs-target="#editCustomerModal<%= c.id %>"
                        title="تحديث بيانات العميل" style="width: 32px; height: 32px;">
                        <i class="bi bi-pencil-square text-info"></i>
                      </button>

                      <form action="/admin/customers/delete/<%= c.id %>" method="post" class="m-0"
                        onsubmit="return confirm('تأكيد: هل تود مسح سجل العميل بالكامل نهائياً؟');">
                        <button type="submit" class="btn btn-light btn-sm rounded-circle border shadow-sm"
                          title="حذف العميل" style="width: 32px; height: 32px;">
                          <i class="bi bi-trash-fill text-danger"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>

                <!-- Premium Edit Modal for Customer -->
                <div class="modal fade" id="editCustomerModal<%= c.id %>" tabindex="-1"
                  aria-labelledby="editCustomerModalLabel<%= c.id %>" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                      <!-- Decorative Top Border -->
                      <div class="bg-info" style="height: 5px; width: 100%;"></div>

                      <form method="post" action="/admin/customers/edit/<%= c.id %>">
                        <div class="modal-header border-bottom-0 pt-4 px-4 pb-0">
                          <h5 class="fw-bold m-0 text-dark d-flex align-items-center gap-2"
                            id="editCustomerModalLabel<%= c.id %>">
                            <i class="bi bi-person-bounding-box text-info"></i> تحديث بطاقة العميل
                          </h5>
                          <button type="button" class="btn-close bg-light rounded-circle shadow-sm"
                            data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <div class="modal-body p-4">
                          <div class="mb-3">
                            <label class="form-label small fw-bold text-muted">الاسم الحقيقي بالكامل <span
                                class="text-danger">*</span></label>
                            <div class="input-group">
                              <span class="input-group-text bg-light text-muted border-end-0"><i
                                  class="bi bi-person"></i></span>
                              <input type="text" name="name" class="form-control border-start-0 ps-0 fw-bold text-dark"
                                value="<%= c.name %>" required>
                            </div>
                          </div>

                          <div class="row g-2 mb-3">
                            <div class="col-6">
                              <label class="form-label small fw-bold text-muted">الهاتف الأساسي</label>
                              <div class="input-group">
                                <span class="input-group-text bg-light text-muted border-end-0"><i
                                    class="bi bi-telephone"></i></span>
                                <input type="text" name="phone"
                                  class="form-control border-start-0 ps-0 text-start font-monospace" dir="ltr"
                                  value="<%= c.phone || '' %>">
                              </div>
                            </div>
                            <div class="col-6">
                              <label class="form-label small fw-bold text-muted">الإيميل الشخصي</label>
                              <div class="input-group">
                                <span class="input-group-text bg-light text-muted border-end-0"><i
                                    class="bi bi-envelope"></i></span>
                                <input type="email" name="email" class="form-control border-start-0 ps-0 text-start"
                                  dir="ltr" value="<%= c.email || '' %>">
                              </div>
                            </div>
                          </div>

                          <div class="mb-2">
                            <label class="form-label small fw-bold text-muted">العنوان أو الحي</label>
                            <div class="input-group">
                              <span class="input-group-text bg-light text-muted border-end-0"><i
                                  class="bi bi-geo-alt"></i></span>
                              <input type="text" name="address" class="form-control border-start-0 ps-0"
                                value="<%= c.address || '' %>">
                            </div>
                          </div>
                        </div>

                        <div class="modal-footer border-top-0 pt-0 pb-4 px-4">
                          <button type="button" class="btn btn-light fw-bold px-4" data-bs-dismiss="modal">اغلاق
                            كلي</button>
                          <button type="submit" class="btn btn-info text-white fw-bold shadow-sm px-4"><i
                              class="bi bi-check2-circle mb-1 ms-1"></i> اعتماد البيانات</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                <% }); %>

                  <% if (!customers.length) { %>
                    <tr>
                      <td colspan="5" class="text-center py-5">
                        <div
                          class="d-flex flex-column align-items-center justify-content-center py-4 text-muted opacity-50">
                          <div
                            class="bg-light rounded-circle d-flex align-items-center justify-content-center mb-3 shadow-sm border"
                            style="width: 80px; height: 80px;">
                            <i class="bi bi-people fs-1 text-secondary"></i>
                          </div>
                          <h5 class="fw-bold text-dark mt-2 mb-1">دليل العملاء فارغ</h5>
                          <p class="m-0 small">لم يتم إضافة أو تسجيل أي نشاط لعملاء حتى الآن. قم بإنشاء السجل الأول!</p>
                        </div>
                      </td>
                    </tr>
                    <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <%- include('../partials/scripts') %>