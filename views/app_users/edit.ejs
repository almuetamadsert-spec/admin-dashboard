<%- include('../partials/head', { title: 'تعديل مستخدم التطبيق' }) %>
<%- include('../partials/sidebar', { adminUsername }) %>

<h4 class="mb-4">ربط حساب التاجر بمتجر</h4>

<% if (!merchants || merchants.length === 0) { %>
<div class="alert alert-warning">لا يوجد تجار. <a href="/admin/merchants">أضف تاجراً</a> أولاً ثم ارجع لربط الحساب به.</div>
<% } %>

<div class="card">
  <div class="card-body">
    <form method="post" action="/admin/app-users/edit/<%= user.id %>">
      <div class="mb-3">
        <label class="form-label">الإيميل</label>
        <input type="text" class="form-control" value="<%= user.email %>" readonly>
      </div>
      <div class="mb-3">
        <label class="form-label">الرتبة</label>
        <select name="role" class="form-select" id="editRole">
          <option value="customer" <%= user.role === 'customer' ? 'selected' : '' %>>عميل</option>
          <option value="merchant" <%= user.role === 'merchant' ? 'selected' : '' %>>تاجر</option>
        </select>
      </div>
      <div class="mb-3" id="editMerchantWrap">
        <label class="form-label">ربط بالتاجر (المتجر)</label>
        <select name="merchant_id" class="form-select">
          <option value="">— اختر التاجر —</option>
          <% (merchants || []).forEach(function(m) { %>
          <option value="<%= m.id %>" <%= user.merchant_id == m.id ? 'selected' : '' %>><%= m.name %> — <%= m.store_name || '' %></option>
          <% }); %>
        </select>
        <p class="form-text text-warning mb-0">حساب التاجر يجب أن يكون مرتبطاً بتاجر من قائمة التجار حتى يعمل في التطبيق.</p>
      </div>
      <div class="mb-3">
        <label class="form-label">كلمة مرور جديدة (اختياري)</label>
        <input type="password" name="password" class="form-control" placeholder="اتركه فارغاً للإبقاء على الحالية" minlength="4">
      </div>
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">حفظ</button>
        <a href="/admin/app-users" class="btn btn-secondary">إلغاء</a>
      </div>
    </form>
  </div>
</div>

<script>
(function() {
  var role = document.getElementById('editRole');
  var wrap = document.getElementById('editMerchantWrap');
  if (!role || !wrap) return;
  function toggle() { wrap.style.display = role.value === 'merchant' ? '' : 'none'; }
  role.addEventListener('change', toggle);
  toggle();
})();
</script>

<%- include('../partials/scripts') %>
