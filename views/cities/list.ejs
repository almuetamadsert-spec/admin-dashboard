<%- include('../partials/head', { title: 'مدن التوصيل والرسوم' }) %>
  <%- include('../partials/sidebar', { adminUsername }) %>

    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h4 class="fw-bold m-0 text-dark">مدن التوصيل والرسوم</h4>
        <p class="text-muted small mb-0">إدارة مناطق التغطية وتكاليف التوصيل لكل مدينة</p>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card stat-card p-4">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-card-icon" style="background: rgba(14, 165, 233, 0.1); color: #0ea5e9;">
              <i class="bi bi-geo-alt"></i>
            </div>
            <div>
              <h6 class="text-muted mb-1">إجمالي المدن</h6>
              <h3 class="mb-0 fw-bold">
                <%= totalCount %>
              </h3>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stat-card p-4">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-card-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
              <i class="bi bi-check-circle"></i>
            </div>
            <div>
              <h6 class="text-muted mb-1">المدن النشطة</h6>
              <h3 class="mb-0 fw-bold text-success">
                <%= activeCount %>
              </h3>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stat-card p-4">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-card-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
              <i class="bi bi-x-circle"></i>
            </div>
            <div>
              <h6 class="text-muted mb-1">المدن المعطلة</h6>
              <h3 class="mb-0 fw-bold text-danger">
                <%= disabledCount %>
              </h3>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body p-4">
        <h6 class="fw-bold mb-3 text-dark">إضافة مدينة جديدة</h6>
        <form method="post" action="/admin/cities" class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label small text-muted">اسم المدينة</label>
            <input type="text" name="name" class="form-control" placeholder="مثال: طرابلس" required>
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">رسوم التوصيل (د.ل)</label>
            <input type="number" step="0.01" name="delivery_fee" class="form-control" placeholder="0.00" value="0">
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">الحالة التشغيلية</label>
            <select name="is_active" class="form-select">
              <option value="1">تفعيل فوري</option>
              <option value="0">تعطيل مؤقت</option>
            </select>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100 py-2">
              <i class="bi bi-plus-lg me-1"></i> حفظ المدينة
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="card border-0 shadow-sm overflow-hidden">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="bg-light bg-opacity-50 border-bottom">
              <tr>
                <th class="ps-4">المدينة</th>
                <th width="200">رسوم التوصيل</th>
                <th width="150">الحالة</th>
                <th class="pe-4 text-end" width="180">إجراءات</th>
              </tr>
            </thead>
            <tbody>
              <% cities.forEach(function(c) { %>
                <tr>
                  <td class="ps-4">
                    <div class="fw-bold text-dark">
                      <%= c.name %>
                    </div>
                  </td>
                  <td>
                    <% if (Number(c.delivery_fee)===0) { %>
                      <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">مجاني</span>
                      <% } else { %>
                        <span class="fw-500">
                          <%= Number(c.delivery_fee).toFixed(2) %> <small class="text-muted">د.ل</small>
                        </span>
                        <% } %>
                  </td>
                  <td>
                    <span
                      class="badge <%= c.is_active ? 'bg-success' : 'bg-danger' %> bg-opacity-10 <%= c.is_active ? 'text-success' : 'text-danger' %> rounded-pill px-3">
                      <%= c.is_active ? 'نشط' : 'معطل' %>
                    </span>
                  </td>
                  <td class="pe-4 text-end">
                    <button type="button" class="btn btn-light btn-sm rounded-circle me-1" data-bs-toggle="modal"
                      data-bs-target="#edit<%= c.id %>" title="تعديل">
                      <i class="bi bi-pencil-square text-primary"></i>
                    </button>
                    <form action="/admin/cities/delete/<%= c.id %>" method="post" class="d-inline"
                      onsubmit="return confirm('هل أنت متأكد من حذف هذه المدينة؟');">
                      <button type="submit" class="btn btn-light btn-sm rounded-circle" title="حذف">
                        <i class="bi bi-trash text-danger"></i>
                      </button>
                    </form>
                  </td>
                </tr>

                <!-- Edit Modal -->
                <div class="modal fade" id="edit<%= c.id %>" tabindex="-1">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                      <form method="post" action="/admin/cities/edit/<%= c.id %>">
                        <div class="modal-header border-bottom-0 pt-4 px-4">
                          <h5 class="fw-bold m-0">تعديل بيانات المدينة</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-4">
                          <div class="mb-3">
                            <label class="form-label small text-muted">اسم المدينة</label>
                            <input type="text" name="name" class="form-control" value="<%= c.name %>" required>
                          </div>
                          <div class="mb-3">
                            <label class="form-label small text-muted">رسوم التوصيل (د.ل)</label>
                            <input type="number" step="0.01" name="delivery_fee" class="form-control"
                              value="<%= c.delivery_fee %>">
                          </div>
                          <div>
                            <label class="form-label small text-muted">حالة التوصيل</label>
                            <select name="is_active" class="form-select">
                              <option value="1" <%=c.is_active ? 'selected' : '' %>>نشط (متاح للتوصيل)</option>
                              <option value="0" <%=!c.is_active ? 'selected' : '' %>>معطل (غير متاح)</option>
                            </select>
                          </div>
                        </div>
                        <div class="modal-footer border-top-0 pb-4 px-4">
                          <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">إلغاء</button>
                          <button type="submit" class="btn btn-primary px-4">حفظ التغييرات</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                <% }); %>
                  <% if (!cities.length) { %>
                    <tr>
                      <td colspan="4" class="text-center py-5">
                        <div class="py-5 text-muted">
                          <i class="bi bi-geo display-4 d-block mb-3 opacity-25"></i>
                          <h5>لا توجد مدن مسجلة</h5>
                          <p class="small mb-0">قم بإضافة مدن جديدة لتظهر هنا</p>
                        </div>
                      </td>
                    </tr>
                    <% } %>
            </tbody>
          </table>
        </div>

        <!-- Pagination Controls -->
        <% if (totalPages> 1) { %>
          <div class="p-4 border-top d-flex justify-content-between align-items-center bg-light bg-opacity-25">
            <div class="text-muted small">
              عرض الصفحة <strong>
                <%= currentPage %>
              </strong> من <strong>
                <%= totalPages %>
              </strong> (إجمالي <strong>
                <%= totalCount %>
              </strong> مدينة)
            </div>
            <nav>
              <ul class="pagination pagination-sm m-0 gap-1">
                <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                  <a class="page-link rounded-pill px-3 border-0 shadow-none"
                    href="?page=<%= currentPage - 1 %>">السابق</a>
                </li>

                <% let startPage=Math.max(1, currentPage - 2); let endPage=Math.min(totalPages, startPage + 4); if
                  (endPage - startPage < 4) startPage=Math.max(1, endPage - 4); %>

                  <% for(let i=startPage; i <=endPage; i++) { %>
                    <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                      <a class="page-link rounded-circle border-0 shadow-none d-flex align-items-center justify-content-center"
                        style="width: 32px; height: 32px;" href="?page=<%= i %>">
                        <%= i %>
                      </a>
                    </li>
                    <% } %>

                      <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                        <a class="page-link rounded-pill px-3 border-0 shadow-none"
                          href="?page=<%= currentPage + 1 %>">التالي</a>
                      </li>
              </ul>
            </nav>
          </div>
          <% } %>
      </div>
    </div>

    <%- include('../partials/scripts') %>