<%- include('../partials/head', { title: order ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨' : 'ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯' }) %>
  <%- include('../partials/sidebar', { adminUsername }) %>

    <style>
      .req-star {
        color: #dc3545;
        font-weight: bold;
        margin-right: 2px;
      }

      .form-section {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        margin-bottom: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        overflow: hidden;
      }

      .form-section-header {
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .form-section-header h6 {
        margin: 0;
        font-weight: 700;
        color: #1e293b;
        font-size: 0.95rem;
      }

      .item-row {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease;
        position: relative;
      }

      .item-row:hover {
        border-color: #3b82f6;
        box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1);
      }

      .btn-remove {
        width: 38px;
        height: 38px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: all 0.2s;
      }

      .product-select {
        font-weight: 600;
        color: #334155;
      }
    </style>

    <div class="container-fluid py-4 px-4 pb-5">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <div class="d-flex align-items-center gap-3">
          <div
            class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center shadow-sm"
            style="width: 50px; height: 50px;">
            <i class="bi <%= order ? 'bi-receipt' : 'bi-cart-plus-fill' %> fs-3"></i>
          </div>
          <div>
            <h4 class="fw-bold m-0 text-dark">
              <%= order ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ' : 'Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªÙˆØ«ÙŠÙ‚ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯' %>
                <% if(order) { %>
                  <span class="badge bg-light text-primary border border-primary px-2 font-monospace">#<%=
                      order.order_number %></span>
                  <% } %>
            </h4>
            <p class="text-muted small mt-1 mb-0">
              <%= order ? 'ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØµÙŠÙ„.'
                : 'ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ ÙŠØ¯ÙˆÙŠ Ù„Ø¥Ø¯Ø±Ø§Ø¬Ù‡ Ø¶Ù…Ù† Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù….' %>
            </p>
          </div>
        </div>
        <div>
          <a href="/admin/orders" class="btn btn-light shadow-sm border fw-bold text-dark"><i
              class="bi bi-arrow-right-circle ms-1"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø³Ø¬Ù„</a>
        </div>
      </div>

      <form method="post" action="<%= order ? '/admin/orders/edit/' + order.id : '/admin/orders' %>" id="orderForm">
        <div class="row g-4">

          <!-- Left/Main Column: Items and Details -->
          <div class="col-lg-8">

            <!-- Products Selection -->
            <div class="form-section border-top border-primary border-4">
              <div class="form-section-header">
                <div
                  class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center"
                  style="width: 32px; height: 32px;">
                  <i class="bi bi-box-seam fs-6"></i>
                </div>
                <h6>Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h6>
              </div>

              <div class="px-4 py-4 bg-white" id="orderItemsContainer">
                <div id="orderItems">
                  <% if (items && items.length) { %>
                    <% items.forEach(function(it) { %>
                      <div class="item-row">
                        <div class="row g-3 align-items-end">
                          <div class="col-md-7">
                            <label class="form-label fw-bold small text-muted mb-2">Ø§Ù„ØµÙ†Ù Ø£Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
                            <div class="input-group">
                              <span class="input-group-text bg-light border-end-0 text-muted"><i
                                  class="bi bi-tag"></i></span>
                              <select name="product_id" class="form-select border-start-0 ps-0 product-select" required>
                                <option value="">â€” Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ â€”</option>
                                <% products.forEach(function(p) { %>
                                  <option value="<%= p.id %>"
                                    data-price="<%= Number(p.price * (1 - (p.discount_percent||0)/100)).toFixed(2) %>"
                                    <%=it.product_id==p.id ? 'selected' : '' %>>
                                    <%= p.name_ar || p.name_en %> (Ø§Ù„Ø³Ø¹Ø±: <%= Number(p.price * (1 -
                                        (p.discount_percent||0)/100)).toFixed(2) %>)
                                  </option>
                                  <% }); %>
                              </select>
                            </div>
                          </div>
                          <div class="col-md-3">
                            <label class="form-label fw-bold small text-muted mb-2">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                            <div class="input-group">
                              <span class="input-group-text bg-light border-end-0 text-muted"><i
                                  class="bi bi-layers"></i></span>
                              <input type="number" name="quantity"
                                class="form-control border-start-0 ps-0 text-center fw-bold" value="<%= it.quantity %>"
                                min="1" required>
                            </div>
                          </div>
                          <div class="col-md-2 text-end">
                            <button type="button" class="btn btn-outline-danger btn-remove border-2"
                              title="Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±">
                              <i class="bi bi-trash3-fill"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                      <% }); %>
                        <% } else { %>
                          <!-- Default empty row -->
                          <div class="item-row">
                            <div class="row g-3 align-items-end">
                              <div class="col-md-7">
                                <label class="form-label fw-bold small text-muted mb-2">Ø§Ù„ØµÙ†Ù Ø£Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
                                <div class="input-group">
                                  <span class="input-group-text bg-light border-end-0 text-muted"><i
                                      class="bi bi-tag"></i></span>
                                  <select name="product_id" class="form-select border-start-0 ps-0 product-select"
                                    required>
                                    <option value="">â€” Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ â€”</option>
                                    <% products.forEach(function(p) { %>
                                      <option value="<%= p.id %>"
                                        data-price="<%= Number(p.price * (1 - (p.discount_percent||0)/100)).toFixed(2) %>">
                                        <%= p.name_ar || p.name_en %> (Ø§Ù„Ø³Ø¹Ø±: <%= Number(p.price * (1 -
                                            (p.discount_percent||0)/100)).toFixed(2) %>)
                                      </option>
                                      <% }); %>
                                  </select>
                                </div>
                              </div>
                              <div class="col-md-3">
                                <label class="form-label fw-bold small text-muted mb-2">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                <div class="input-group">
                                  <span class="input-group-text bg-light border-end-0 text-muted"><i
                                      class="bi bi-layers"></i></span>
                                  <input type="number" name="quantity"
                                    class="form-control border-start-0 ps-0 text-center fw-bold" value="1" min="1"
                                    required>
                                </div>
                              </div>
                              <div class="col-md-2 text-end">
                                <button type="button" class="btn btn-outline-danger btn-remove border-2"
                                  title="Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±">
                                  <i class="bi bi-trash3-fill"></i>
                                </button>
                              </div>
                            </div>
                          </div>
                          <% } %>
                </div>

                <div class="mt-4 text-center">
                  <button type="button" id="addItem"
                    class="btn btn-outline-primary fw-bold px-4 py-2 border-2 rounded-pill shadow-sm">
                    <i class="bi bi-plus-circle-dotted ms-2"></i> Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ù†ØªØ¬ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø·Ù„Ø¨
                  </button>
                </div>
              </div>
            </div>

            <!-- Customer Information -->
            <div class="form-section border-top border-info border-4">
              <div class="form-section-header">
                <div
                  class="bg-info bg-opacity-10 text-info rounded-circle d-flex align-items-center justify-content-center"
                  style="width: 32px; height: 32px;">
                  <i class="bi bi-person-lines-fill fs-6"></i>
                </div>
                <h6>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ù„Ù…Ø´ØªØ±ÙŠ)</h6>
              </div>
              <div class="px-4 py-4">
                <div class="mb-4">
                  <label class="form-label fw-bold text-dark small mb-2"><i class="bi bi-search ms-1 text-info"></i>
                    Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <select name="customer_id" id="customerSelect"
                    class="form-select border-info border-opacity-50 fw-bold shadow-sm">
                    <option value="">â€” ğŸ†• ØªØ³Ø¬ÙŠÙ„ ÙƒØ¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ (ØºÙŠØ± Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…) â€”</option>
                    <% customers.forEach(function(c) { %>
                      <option value="<%= c.id %>" data-name="<%= c.name %>" data-phone="<%= c.phone || '' %>"
                        data-email="<%= c.email || '' %>" data-address="<%= c.address || '' %>" <%=order &&
                        order.customer_id==c.id ? 'selected' : '' %>>
                        ğŸ‘¤ <%= c.name %>
                          <% if(c.phone) { %>| ğŸ“± <%= c.phone %>
                              <% } %>
                                <% if(c.email) { %>| ğŸ“§ <%= c.email %>
                                    <% } %>
                      </option>
                      <% }); %>
                  </select>
                </div>

                <div class="row g-4">
                  <div class="col-md-6">
                    <label class="form-label fw-bold small text-muted">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ <span
                        class="req-star">*</span></label>
                    <div class="input-group">
                      <span class="input-group-text bg-light border-end-0 text-muted"><i
                          class="bi bi-person"></i></span>
                      <input type="text" name="customer_name" id="customer_name"
                        class="form-control border-start-0 ps-0 fw-bold" placeholder="Ø§Ø³Ù… Ù…Ø³ØªÙ„Ù… Ø§Ù„Ø·Ù„Ø¨"
                        value="<%= order ? (order.customer_name || '') : '' %>" required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold small text-muted">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ <span
                        class="req-star">*</span></label>
                    <div class="input-group">
                      <span class="input-group-text bg-light border-end-0 text-muted" dir="ltr">+218</span>
                      <input type="text" name="customer_phone" id="customer_phone"
                        class="form-control border-start-0 ps-0 fw-bold" placeholder="09X XXX XXXX"
                        value="<%= order ? (order.customer_phone || '') : '' %>" required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold small text-muted">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light border-end-0 text-muted"><i
                          class="bi bi-envelope"></i></span>
                      <input type="email" name="customer_email" id="customer_email"
                        class="form-control border-start-0 ps-0" placeholder="example@mail.com"
                        value="<%= order ? (order.customer_email || '') : '' %>">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold small text-muted">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light border-end-0 text-muted"><i
                          class="bi bi-telephone-plus"></i></span>
                      <input type="text" name="customer_phone_alt" id="customer_phone_alt"
                        class="form-control border-start-0 ps-0" placeholder="ÙŠÙØ¶Ù„ Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„"
                        value="<%= order && order.customer_phone_alt ? order.customer_phone_alt : '' %>">
                    </div>
                  </div>
                  <% if (typeof cities !=='undefined' && cities.length) { %>
                    <div class="col-md-4">
                      <label class="form-label fw-bold small text-muted">Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ <span
                          class="req-star">*</span></label>
                      <select name="city_id" class="form-select fw-bold border-2" required>
                        <option value="">â€” Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†Ø© â€”</option>
                        <% cities.forEach(function(c) { %>
                          <option value="<%= c.id %>" <%=order && order.city_id==c.id ? 'selected' : '' %>><%= c.name %>
                          </option>
                          <% }); %>
                      </select>
                    </div>
                    <% } %>
                      <div class="<%= (typeof cities !== 'undefined' && cities.length) ? 'col-md-8' : 'col-md-12' %>">
                        <label class="form-label fw-bold small text-muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ <span
                            class="req-star">*</span></label>
                        <div class="input-group">
                          <span class="input-group-text bg-light border-end-0 text-muted"><i
                              class="bi bi-geo-alt"></i></span>
                          <input type="text" name="customer_address" id="customer_address"
                            class="form-control border-start-0 ps-0" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø£Ù‚Ø±Ø¨ Ù†Ù‚Ø·Ø© Ø¯Ø§Ù„Ø©..."
                            value="<%= order ? (order.customer_address || '') : '' %>" required>
                        </div>
                      </div>
                </div>
              </div>
            </div>

          </div>

          <!-- Right Column: Meta, Status, Action -->
          <div class="col-lg-4">

            <!-- Order Status & Management -->
            <div class="form-section border-top border-warning border-4">
              <div class="form-section-header">
                <div
                  class="bg-warning bg-opacity-10 text-warning rounded-circle d-flex align-items-center justify-content-center"
                  style="width: 32px; height: 32px;">
                  <i class="bi bi-gear-wide-connected fs-6"></i>
                </div>
                <h6>Ø¥Ø¯Ø§Ø±Ø© ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h6>
              </div>
              <div class="px-4 py-4">
                <div class="mb-4">
                  <label class="form-label fw-bold small text-dark mb-2">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© Ù„Ù„Ø·Ù„Ø¨</label>

                  <% let currentStatus=order ? order.status : 'pending' ; let colorBase='warning' ;
                    if(currentStatus==='confirmed' ) colorBase='primary' ; if(currentStatus==='shipped' )
                    colorBase='info' ; if(currentStatus==='delivered' ) colorBase='success' ;
                    if(currentStatus==='cancelled' || currentStatus==='customer_refused' ) colorBase='danger' ; %>

                    <select name="status"
                      class="form-select form-select-lg w-100 fw-bold border-2 border-<%= colorBase %> text-<%= colorBase %> bg-<%= colorBase %> bg-opacity-10 shadow-sm"
                      id="statusSelectDropdown">
                      <option value="pending" class="text-warning fw-bold" <%=currentStatus==='pending' ? 'selected'
                        : '' %>>ğŸŸ¡ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Ù„Ù… ÙŠØ¤ÙƒØ¯)</option>
                      <option value="confirmed" class="text-primary fw-bold" <%=currentStatus==='confirmed' ? 'selected'
                        : '' %>>ğŸ”µ Ù…Ø¤ÙƒØ¯ (Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²)</option>
                      <option value="shipped" class="text-info fw-bold" <%=currentStatus==='shipped' ? 'selected' : ''
                        %>>ğŸ§Š ØªÙ… Ø§Ù„Ø´Ø­Ù† Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</option>
                      <option value="delivered" class="text-success fw-bold" <%=currentStatus==='delivered' ? 'selected'
                        : '' %>>ğŸŸ¢ ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­</option>
                      <option value="cancelled" class="text-danger fw-bold" <%=currentStatus==='cancelled' ? 'selected'
                        : '' %>>ğŸ”´ Ù…Ù„ØºÙŠ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</option>
                      <option value="customer_refused" class="text-danger fw-bold" <%=currentStatus==='customer_refused'
                        ? 'selected' : '' %>>â›” Ø±ÙØ¶ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
                    </select>
                </div>

                <% if (typeof merchants !=='undefined' && merchants.length) { %>
                  <div class="mb-4 p-3 bg-light rounded-4 border">
                    <label class="form-label fw-bold small text-dark mb-2"><i class="bi bi-shop text-muted me-1"></i>
                      Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ Ù„ØªØ§Ø¬Ø±</label>
                    <select name="merchant_id" class="form-select fw-bold border-secondary border-opacity-25">
                      <option value="">â€” ØªÙ†ÙÙŠØ° Ø¯Ø§Ø®Ù„ÙŠ â€”</option>
                      <% merchants.forEach(function(m) { %>
                        <option value="<%= m.id %>" <%=order && order.merchant_id==m.id ? 'selected' : '' %>>
                          <%= (m.store_name || m.name || '' ) %>
                        </option>
                        <% }); %>
                    </select>
                  </div>
                  <% } %>

                    <div class="mb-4">
                      <label class="form-label fw-bold small text-dark mb-2"><i
                          class="bi bi-pencil-square text-muted me-1"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
                      <textarea name="notes" class="form-control bg-light border-0 rounded-4" rows="4"
                        placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„ØªØ´ØºÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨..."><%= order ? (order.notes || '') : '' %></textarea>
                    </div>

                    <div class="d-grid gap-2">
                      <button type="submit" class="btn btn-primary btn-lg fw-bold shadow-sm py-3 rounded-4">
                        <i class="bi <%= order ? 'bi-check2-circle' : 'bi-plus-circle' %> me-2 fs-5"></i>
                        <%= order ? 'Ø­ÙØ¸ Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ù‘Ø«Ø©' : 'ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯' %>
                      </button>
                    </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Raw Template for dynamically adding rows -->
    <div id="itemTemplateRow" style="display: none;">
      <div class="item-row">
        <div class="row g-3 align-items-end">
          <div class="col-md-7">
            <label class="form-label fw-bold small text-muted mb-2">Ø§Ù„ØµÙ†Ù Ø£Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
            <div class="input-group">
              <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-tag"></i></span>
              <select name="product_id" class="form-select border-start-0 ps-0 product-select" required disabled>
                <option value="">â€” Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ â€”</option>
                <% if (typeof products !=='undefined' && products) { %>
                  <% products.forEach(function(p) { %>
                    <option value="<%= p.id %>"
                      data-price="<%= Number(p.price * (1 - (p.discount_percent||0)/100)).toFixed(2) %>">
                      <%= p.name_ar || p.name_en %> (Ø§Ù„Ø³Ø¹Ø±: <%= Number(p.price * (1 -
                          (p.discount_percent||0)/100)).toFixed(2) %>)
                    </option>
                    <% }); %>
                      <% } %>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-bold small text-muted mb-2">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
            <div class="input-group">
              <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-layers"></i></span>
              <input type="number" name="quantity" class="form-control border-start-0 ps-0 text-center fw-bold"
                value="1" min="1" required disabled>
            </div>
          </div>
          <div class="col-md-2 text-end">
            <button type="button" class="btn btn-outline-danger btn-remove border-2" title="Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±">
              <i class="bi bi-trash3-fill"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {

        // Auto-fill customer details functionality
        const customerSelect = document.getElementById('customerSelect');
        if (customerSelect) {
          customerSelect.addEventListener('change', function () {
            var opt = this.options[this.selectedIndex];
            if (opt && opt.value) {
              document.getElementById('customer_name').value = opt.dataset.name || '';
              document.getElementById('customer_phone').value = opt.dataset.phone || '';
              document.getElementById('customer_email').value = opt.dataset.email || '';
              document.getElementById('customer_address').value = opt.dataset.address || '';

              // Highlight fields briefly to show they were updated
              ['customer_name', 'customer_phone', 'customer_email', 'customer_address'].forEach(id => {
                let el = document.getElementById(id);
                if (el && el.value !== '') {
                  el.classList.add('bg-success', 'bg-opacity-10', 'border-success');
                  setTimeout(() => el.classList.remove('bg-success', 'bg-opacity-10', 'border-success'), 1500);
                }
              });
            }
          });
        }

        // Dynamic Row Addition functionality
        const btnAddItem = document.getElementById('addItem');
        const orderItemsContainer = document.getElementById('orderItems');
        const rawTemplate = document.getElementById('itemTemplateRow');

        if (btnAddItem && orderItemsContainer && rawTemplate) {
          btnAddItem.addEventListener('click', function () {
            // Clone the first div inside the raw template
            const clone = rawTemplate.children[0].cloneNode(true);

            // Re-enable form inputs in the clone
            clone.querySelectorAll('input, select').forEach(el => {
              el.disabled = false;
            });

            // Add tiny animation class (requires animate.css or similar, or just relying on css transition)
            clone.style.opacity = '0';
            orderItemsContainer.appendChild(clone);

            // Simple fade-in effect
            setTimeout(() => {
              clone.style.transition = 'opacity 0.3s ease-in';
              clone.style.opacity = '1';
            }, 10);
          });
        }

        // Delegation for dynamic delete buttons
        if (orderItemsContainer) {
          orderItemsContainer.addEventListener('click', function (e) {
            // Find closest element with class btn-remove
            const removeBtn = e.target.closest('.btn-remove');
            if (removeBtn) {
              // Ensure at least one row remains
              if (orderItemsContainer.querySelectorAll('.item-row').length > 1) {
                const rowToRemove = removeBtn.closest('.item-row');

                // Fade out then remove
                rowToRemove.style.transition = 'opacity 0.2s';
                rowToRemove.style.opacity = '0';
                setTimeout(() => {
                  rowToRemove.remove();
                }, 200);
              } else {
                alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
              }
            }
          });
        }

        // Dynamic color change for status select
        const statusSelectDropdown = document.getElementById('statusSelectDropdown');
        if (statusSelectDropdown) {
          statusSelectDropdown.addEventListener('change', function () {
            // Remove all custom classes
            this.classList.remove(
              'border-warning', 'text-warning', 'bg-warning',
              'border-primary', 'text-primary', 'bg-primary',
              'border-info', 'text-info', 'bg-info',
              'border-success', 'text-success', 'bg-success',
              'border-danger', 'text-danger', 'bg-danger',
              'bg-opacity-10'
            );

            // Add appropriate classes
            this.classList.add('bg-opacity-10');

            if (this.value === 'pending') this.classList.add('border-warning', 'text-warning', 'bg-warning');
            else if (this.value === 'confirmed') this.classList.add('border-primary', 'text-primary', 'bg-primary');
            else if (this.value === 'shipped') this.classList.add('border-info', 'text-info', 'bg-info');
            else if (this.value === 'delivered') this.classList.add('border-success', 'text-success', 'bg-success');
            else if (this.value === 'cancelled' || this.value === 'customer_refused') this.classList.add('border-danger', 'text-danger', 'bg-danger');
          });
        }
      });
    </script>

    <%- include('../partials/scripts') %>