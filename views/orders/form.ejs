<%- include('../partials/head', { title: 'طلب جديد' }) %>
<%- include('../partials/sidebar', { adminUsername }) %>

<h4 class="mb-4">إنشاء طلب جديد</h4>
<form method="post" action="/admin/orders" class="card p-4">
  <h6 class="mb-3">العميل</h6>
  <div class="row mb-3">
    <div class="col-md-6">
      <label class="form-label">اختيار عميل (اختياري)</label>
      <select name="customer_id" id="customerSelect" class="form-select">
        <option value="">— عميل جديد —</option>
        <% customers.forEach(function(c) { %>
        <option value="<%= c.id %>" data-name="<%= c.name %>" data-phone="<%= c.phone || '' %>" data-email="<%= c.email || '' %>" data-address="<%= c.address || '' %>"><%= c.name %> - <%= c.phone || c.email %></option>
        <% }); %>
      </select>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="form-label">اسم العميل</label>
      <input type="text" name="customer_name" id="customer_name" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">الهاتف</label>
      <input type="text" name="customer_phone" id="customer_phone" class="form-control">
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">البريد</label>
      <input type="email" name="customer_email" id="customer_email" class="form-control">
    </div>
  </div>
  <div class="mb-3">
    <label class="form-label">العنوان</label>
    <input type="text" name="customer_address" id="customer_address" class="form-control">
  </div>
  <hr>
  <h6 class="mb-3">المنتجات</h6>
  <div id="orderItems">
    <div class="row align-items-end mb-2 item-row">
      <div class="col-md-6">
        <label class="form-label">المنتج</label>
        <select name="product_id" class="form-select product-select">
          <option value="">— اختر —</option>
          <% products.forEach(function(p) { %>
          <option value="<%= p.id %>" data-price="<%= (p.price * (1 - (p.discount_percent||0)/100)).toFixed(2) %>"><%= p.name_ar || p.name_en %> - <%= p.price %> د.ل</option>
          <% }); %>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">الكمية</label>
        <input type="number" name="quantity" class="form-control quantity" value="1" min="1">
      </div>
      <div class="col-md-2">
        <button type="button" class="btn btn-outline-danger btn-remove">حذف</button>
      </div>
    </div>
  </div>
  <button type="button" id="addItem" class="btn btn-outline-primary btn-sm mb-3"><i class="bi bi-plus"></i> إضافة منتج</button>
  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="form-label">الحالة</label>
      <select name="status" class="form-select">
        <option value="pending">قيد الانتظار</option>
        <option value="confirmed">مؤكد</option>
        <option value="shipped">تم الشحن</option>
        <option value="delivered">تم التوصيل</option>
        <option value="cancelled">ملغي</option>
      </select>
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label">ملاحظات</label>
      <input type="text" name="notes" class="form-control">
    </div>
  </div>
  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-primary">إنشاء الطلب</button>
    <a href="/admin/orders" class="btn btn-outline-secondary">إلغاء</a>
  </div>
</form>

<script>
document.getElementById('customerSelect').addEventListener('change', function() {
  var opt = this.options[this.selectedIndex];
  if (opt.value) {
    document.getElementById('customer_name').value = opt.dataset.name || '';
    document.getElementById('customer_phone').value = opt.dataset.phone || '';
    document.getElementById('customer_email').value = opt.dataset.email || '';
    document.getElementById('customer_address').value = opt.dataset.address || '';
  }
});
var itemTemplate = document.querySelector('.item-row').cloneNode(true);
itemTemplate.querySelector('.product-select').selectedIndex = 0;
itemTemplate.querySelector('.quantity').value = 1;
document.getElementById('addItem').onclick = function() {
  document.getElementById('orderItems').appendChild(itemTemplate.cloneNode(true));
};
document.getElementById('orderItems').addEventListener('click', function(e) {
  if (e.target.classList.contains('btn-remove')) e.target.closest('.item-row').remove();
});
</script>
<%- include('../partials/scripts') %>
