# هيكلة تطبيق Flutter — تطبيق واحد بواجهتين (عميل / تاجر)

## المبدأ
- **تطبيق واحد** مع واجهتين مختلفتين حسب **رتبة المستخدم** (`customer` | `merchant`).
- **دخول موحد** (إيميل، جوجل، أبل) → السيرفر يرجع `role` → **بوابة التوجيه** توجه إما لواجهة المتجر أو لواجهة التاجر.

---

## 1. نظام الدخول (Auth)

- **شاشة دخول**: إيميل + كلمة مرور، زر جوجل، زر أبل.
- عند النجاح: السيرفر يرجع `{ token, role, merchantId? }`.
- **Router**: إذا `role == 'customer'` → واجهة المتجر (لون أزرق `#06a3e7`).  
  إذا `role == 'merchant'` → واجهة "متابعة المتاجر" (لوحة التاجر).

---

## 2. واجهة العميل (Customer App)

| المكوّن | الوصف |
|--------|--------|
| **الصفحة الرئيسية** | عرض المنتجات التقنية من لوحة التحكم (من API الحالي `/api/products`). |
| **الموقع/المدينة** | عند إتمام الطلب يختار العميل **المدينة** من قائمة المدن (API `/api/cities`) — مفتاح توجيه الطلب حسب `normalize_libya_city_v14`. |
| **سلة التسوق** | حساب الإجمالي + **سعر التوصيل** حسب المدينة المختارة (من `delivery_fee` في المدن). |
| **إرسال الطلب** | POST `/api/orders` مع `city_id` وبيانات العميل والعناصر. |

---

## 3. واجهة التاجر (Merchant Dashboard)

| المكوّن | الوصف |
|--------|--------|
| **استلام الطلب** | عرض الطلبات القادمة من **مدينة التاجر فقط** (أو المعينة له). |
| **معاينة الطلب** | تفاصيل المنتجات، الكميات، الأسعار، الإجمالي، بيانات العميل. |
| **الإحصائيات** | بطاقة أداء التاجر (سرعة الرد، المبيعات) من سجلات النظام. |
| **تحويل الطلب** | زر "تحويل الطلب" لتاجر آخر عند عدم إمكانية التنفيذ → API تحويل الطلب. |

---

## 4. هيكل مجلدات Flutter (مقترح)

```
lib/
├── main.dart                 # نقطة البداية + MaterialApp + Router حسب role
├── app.dart                  # التطبيق الرئيسي (يتحقق من التوكن و role)
├── config.dart               # قاعدة الرابط + مفاتيح API (موجود)
│
├── core/
│   ├── auth/
│   │   ├── auth_service.dart       # تسجيل الدخول، حفظ التوكن و role
│   │   ├── auth_state.dart         # حالة المستخدم (معرف، role، merchantId)
│   │   └── login_screen.dart       # شاشة الدخول (إيميل، جوجل، أبل)
│   └── router/
│       └── app_router.dart         # التوجيه: customer → CustomerShell, merchant → MerchantShell
│
├── customer/                        # واجهة العميل (لون #06a3e7)
│   ├── customer_shell.dart         # الهيكل العام (صفحة رئيسية، سلة، إلخ)
│   ├── screens/
│   │   ├── products_screen.dart    # قائمة المنتجات (موجود أو يُنقل)
│   │   ├── cart_screen.dart        # السلة (موجود أو يُنقل)
│   │   └── checkout_screen.dart   # إتمام الطلب + اختيار المدينة + التوصيل
│   └── widgets/
│
├── merchant/                        # واجهة التاجر (لوحة متابعة)
│   ├── merchant_shell.dart         # الهيكل العام (قائمة طلبات، إحصائيات، إعدادات)
│   ├── screens/
│   │   ├── orders_list_screen.dart # طلبات مدينة التاجر
│   │   ├── order_detail_screen.dart# تفاصيل الطلب + زر التحويل
│   │   └── stats_screen.dart       # بطاقة الأداء (سرعة رد، مبيعات)
│   └── widgets/
│
├── api/
│   ├── api_client.dart             # المنتجات، المدن، الطلبات (موجود)
│   ├── auth_api.dart               # تسجيل الدخول، /api/auth/me
│   └── merchant_api.dart           # طلبات التاجر، تحويل الطلب
│
└── models/
    ├── product.dart
    ├── city.dart
    ├── cart_item.dart
    ├── order.dart                  # نموذج الطلب للتاجر
    └── user_session.dart           # token, role, merchantId
```

---

## 5. API Backend المطلوبة

| المسار | الوصف |
|--------|--------|
| `POST /api/auth/login` | إيميل + كلمة مرور (أو لاحقاً id_token جوجل/أبل) → يرجع `{ token, role, merchantId? }`. |
| `GET /api/auth/me` | هيدر `Authorization: Bearer <token>` → يرجع المستخدم و role. |
| `GET /api/merchant/orders` | طلبات مدينة التاجر (أو المعينة له) — يتطلب توكن تاجر. |
| `GET /api/merchant/orders/:id` | تفاصيل طلب واحد. |
| `POST /api/merchant/orders/:id/transfer` | تحويل الطلب لتاجر آخر `{ target_merchant_id }`. |
| (موجود) `GET /api/products` | للمتجر. |
| (موجود) `GET /api/cities` | لاختيار المدينة وسعر التوصيل. |
| (موجود) `POST /api/orders` | لإنشاء طلب من واجهة العميل. |

---

## 6. قاعدة البيانات (Backend)

- **app_users**: مستخدمي التطبيق (إيميل، هاش كلمة المرور، `role`: customer | merchant، `merchant_id` إن كان تاجراً، حقول اختيارية لجوجل/أبل لاحقاً).
- **app_sessions** أو تخزين توكن في الذاكرة/جدول مع انتهاء صلاحية لاستخدامه في `GET /api/auth/me` وواجهات التاجر.

---

## 7. تسلسل التشغيل

1. فتح التطبيق → إن وُجد `token` محفوظ: استدعاء `GET /api/auth/me` → حسب `role` توجيه لـ Customer أو Merchant.
2. إن لم يوجد توكن: عرض **شاشة الدخول**.
3. بعد تسجيل الدخول بنجاح: حفظ `token` و `role` → التوجيه حسب الـ role.

هذه الوثيقة هي المرجع لتنفيذ التطبيق والـ API دون المساس بمنطق لوحة التحكم الحالية.

---

## 8. حسابات الاختبار (بعد أول تشغيل للسيرفر)

يُنشَأ تلقائياً مستخدمان إذا كان جدول `app_users` فارغاً:

| الإيميل             | كلمة المرور | الرتبة   |
|---------------------|-------------|----------|
| `customer@test.com` | `123456`    | عميل     |
| `merchant@test.com` | `123456`    | تاجر (مرتبط بأول تاجر في النظام) |

لتسجيل الدخول من التطبيق: استخدم نفس **مفاتيح API** (Consumer Key / Secret) من الإعدادات في لوحة التحكم، وضعها في `lib/config.dart`. ثم شغّل التطبيق وادخل بأحد الحسابين أعلاه.

---

## 9. تشغيل تطبيق Flutter

```bash
cd store_app
flutter pub get
flutter run
```

للهاتف الحقيقي: في `lib/config.dart` ضع `baseUrlOverride = 'http://IP_الكمبيوتر:3000'` (نفس الشبكة).
