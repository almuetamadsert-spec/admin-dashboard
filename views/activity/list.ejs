<%- include('../partials/head', { title: 'سجل نشاط النظام' }) %>
  <%- include('../partials/sidebar', { adminUsername }) %>

    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h4 class="fw-bold m-0 text-dark">سجل نشاط النظام</h4>
        <p class="text-muted small mb-0">تتبع كافة الإجراءات والعمليات التي تمت على لوحة التحكم</p>
      </div>
    </div>

    <% const today=new Date().toISOString().split('T')[0]; const todayLogs=list.filter(r=> new
      Date(r.created_at).toISOString().split('T')[0] === today).length;
      %>

      <div class="row g-3 mb-4">
        <!-- Activity Summary Cards -->
        <div class="col-md-6">
          <div class="card stat-card p-4">
            <div class="d-flex align-items-center gap-3">
              <div class="stat-card-icon" style="background: rgba(14, 165, 233, 0.1); color: #0ea5e9;">
                <i class="bi bi-clock-history"></i>
              </div>
              <div>
                <h6 class="text-muted mb-1">إجمالي العمليات المسجلة</h6>
                <h3 class="mb-0 fw-bold">
                  <%= totalCount %>
                </h3>
                <p class="small text-muted mb-0 mt-1">آخر 200 عملية</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card stat-card p-4">
            <div class="d-flex align-items-center gap-3">
              <div class="stat-card-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                <i class="bi bi-lightning-charge"></i>
              </div>
              <div>
                <h6 class="text-muted mb-1">نشاط اليوم</h6>
                <h3 class="mb-0 fw-bold text-success">
                  <%= todayLogs %>
                </h3>
                <p class="small text-muted mb-0 mt-1">عمليات تمت خلال 24 ساعة</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Log Table Section -->
      <div class="card border-0 shadow-sm overflow-hidden">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="bg-light bg-opacity-50 border-bottom">
                <tr>
                  <th class="ps-4" width="220">الوقت والتاريخ</th>
                  <th width="180">المسؤول</th>
                  <th width="150">نوع الإجراء</th>
                  <th class="pe-4">التفاصيل الكاملة</th>
                </tr>
              </thead>
              <tbody>
                <% list.forEach(function(r) { %>
                  <% let iconClass='bi-info-circle' ; let iconBg='rgba(108, 117, 125, 0.1)' ; let iconColor='#6c757d' ;
                    if (r.action.includes('إضافة')) { iconClass='bi-plus-circle' ; iconBg='rgba(16, 185, 129, 0.1)' ;
                    iconColor='#10b981' ; } else if (r.action.includes('تعديل')) { iconClass='bi-pencil' ;
                    iconBg='rgba(14, 165, 233, 0.1)' ; iconColor='#0ea5e9' ; } else if (r.action.includes('حذف')) {
                    iconClass='bi-trash' ; iconBg='rgba(239, 68, 68, 0.1)' ; iconColor='#ef4444' ; } else if
                    (r.action.includes('دخول') || r.action.includes('تسجيل')) { iconClass='bi-shield-lock' ;
                    iconBg='rgba(99, 102, 241, 0.1)' ; iconColor='#6366f1' ; } %>
                    <tr>
                      <td class="ps-4">
                        <div class="d-flex flex-column small">
                          <span class="fw-bold text-dark">
                            <%= new Date(r.created_at).toLocaleTimeString('ar-LY', { hour: '2-digit' , minute: '2-digit'
                              }) %>
                          </span>
                          <span class="text-muted">
                            <%= new Date(r.created_at).toLocaleDateString('ar-LY') %>
                          </span>
                        </div>
                      </td>
                      <td>
                        <div class="d-flex align-items-center">
                          <div
                            class="avatar-xs me-2 rounded-circle bg-light d-flex align-items-center justify-content-center text-primary fw-bold"
                            style="width: 24px; height: 24px; font-size: 10px;">
                            <%= (r.admin_name || 'A' )[0].toUpperCase() %>
                          </div>
                          <span class="small fw-500">
                            <%= r.admin_name || 'نظام' %>
                          </span>
                        </div>
                      </td>
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="rounded-circle d-flex align-items-center justify-content-center me-2"
                            style="width: 28px; height: 28px; background: <%= iconBg %>; color: <%= iconColor %>; font-size: 14px;">
                            <i class="bi <%= iconClass %>"></i>
                          </div>
                          <span class="small text-dark fw-500">
                            <%= r.action %>
                          </span>
                        </div>
                      </td>
                      <td class="pe-4">
                        <div class="text-muted small py-1" style="max-width: 500px; white-space: normal;">
                          <%= r.details || '—' %>
                        </div>
                      </td>
                    </tr>
                    <% }); %>
                      <% if (!list.length) { %>
                        <tr>
                          <td colspan="4" class="text-center py-5">
                            <div class="py-5 text-muted">
                              <i class="bi bi-journal-text display-4 d-block mb-3 opacity-25"></i>
                              <h5>لا توجد سجلات حالياً</h5>
                              <p class="small mb-0">كافة العمليات ستظهر هنا بشكل تلقائي</p>
                            </div>
                          </td>
                        </tr>
                        <% } %>
              </tbody>
            </table>
          </div>

          <!-- Pagination Controls -->
          <% if (totalPages> 1) { %>
            <div class="p-4 border-top d-flex justify-content-between align-items-center bg-light bg-opacity-25">
              <div class="text-muted small">
                عرض الصفحة <strong>
                  <%= currentPage %>
                </strong> من <strong>
                  <%= totalPages %>
                </strong> (إجمالي <strong>
                  <%= totalCount %>
                </strong> عملية)
              </div>
              <nav>
                <ul class="pagination pagination-sm m-0 gap-1">
                  <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                    <a class="page-link rounded-pill px-3 border-0 shadow-none"
                      href="?page=<%= currentPage - 1 %>">السابق</a>
                  </li>

                  <% let startPage=Math.max(1, currentPage - 2); let endPage=Math.min(totalPages, startPage + 4); if
                    (endPage - startPage < 4) startPage=Math.max(1, endPage - 4); %>

                    <% for(let i=startPage; i <=endPage; i++) { %>
                      <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                        <a class="page-link rounded-circle border-0 shadow-none d-flex align-items-center justify-content-center"
                          style="width: 32px; height: 32px;" href="?page=<%= i %>">
                          <%= i %>
                        </a>
                      </li>
                      <% } %>

                        <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                          <a class="page-link rounded-pill px-3 border-0 shadow-none"
                            href="?page=<%= currentPage + 1 %>">التالي</a>
                        </li>
                </ul>
              </nav>
            </div>
            <% } %>
        </div>
      </div>

      <%- include('../partials/scripts') %>