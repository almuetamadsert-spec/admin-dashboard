<%- include('../partials/head', { title: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª' }) %>
  <%- include('../partials/sidebar', { adminUsername }) %>

    <style>
      .product-img-wrapper {
        position: relative;
        width: 48px;
        height: 48px;
        border-radius: 8px;
        overflow: hidden;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .product-img-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        padding: 2px;
      }

      .stats-icon-box {
        width: 54px;
        height: 54px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
      }

      .table-premium th {
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        padding-top: 1rem;
        padding-bottom: 1rem;
      }
    </style>

    <div class="container-fluid py-4 px-4 pb-5">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h4 class="fw-bold m-0 text-dark d-flex align-items-center gap-2">
            <i class="bi bi-box-seam text-primary"></i> Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
          </h4>
          <p class="text-muted small mt-1 mb-0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŒ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù„Ø¬Ù…ÙŠØ¹ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±.</p>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-light shadow-sm border px-3 fw-bold text-dark" data-bs-toggle="modal"
            data-bs-target="#importModal">
            <i class="bi bi-file-earmark-excel text-success ms-1"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV
          </button>
          <a href="/admin/products/new" class="btn btn-primary px-4 shadow-sm fw-bold">
            <i class="bi bi-plus-circle ms-1"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
          </a>
        </div>
      </div>

      <!-- Inventory Stats Cards -->
      <div class="row g-4 mb-4">
        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100 p-4 border-start border-primary border-4">
            <div class="d-flex align-items-center gap-3">
              <div class="stats-icon-box bg-primary bg-opacity-10 text-primary">
                <i class="bi bi-boxes"></i>
              </div>
              <div>
                <small class="text-muted fw-bold d-block mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</small>
                <h3 class="fw-bold m-0 text-dark">
                  <%= stats.total %>
                </h3>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100 p-4 border-start border-success border-4">
            <div class="d-flex align-items-center gap-3">
              <div class="stats-icon-box bg-success bg-opacity-10 text-success">
                <i class="bi bi-check-circle-fill"></i>
              </div>
              <div>
                <small class="text-muted fw-bold d-block mb-1">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø¨Ø§Ù„Ù…ØªØ¬Ø±</small>
                <h3 class="fw-bold m-0 text-dark">
                  <%= stats.active %>
                </h3>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100 p-4 border-start border-warning border-4">
            <div class="d-flex align-items-center gap-3">
              <div class="stats-icon-box bg-warning bg-opacity-10 text-warning">
                <i class="bi bi-exclamation-triangle-fill"></i>
              </div>
              <div>
                <small class="text-muted fw-bold d-block mb-1">Ù‚Ø§Ø±Ø¨Øª Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙØ§Ø¯</small>
                <h3 class="fw-bold m-0 text-dark">
                  <%= stats.lowStock %>
                </h3>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100 p-4 border-start border-danger border-4">
            <div class="d-flex align-items-center gap-3">
              <div class="stats-icon-box bg-danger bg-opacity-10 text-danger">
                <i class="bi bi-x-circle-fill"></i>
              </div>
              <div>
                <small class="text-muted fw-bold d-block mb-1">Ù†ÙØ¯Øª Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø§Ù„Ù…Ø®Ø²Ù†</small>
                <h3 class="fw-bold m-0 text-danger">
                  <%= stats.outOfStock %>
                </h3>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filter Bar -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          <form method="get" action="/admin/products" class="row g-3 align-items-end">
            <div class="col-lg-5">
              <label class="form-label small fw-bold text-muted"><i class="bi bi-search me-1"></i> Ø¨Ø­Ø« Ø¯Ù‚ÙŠÙ‚</label>
              <div class="input-group">
                <input type="text" name="q" class="form-control bg-light"
                  placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£ÙˆØ§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©..." value="<%= filters.q %>">
              </div>
            </div>
            <div class="col-lg-3 col-md-4">
              <label class="form-label small fw-bold text-muted"><i class="bi bi-tags me-1"></i> ØªØµÙÙŠØ© Ø¨Ø§Ù„ØªØµÙ†ÙŠÙ</label>
              <select name="category_id" class="form-select bg-light">
                <option value="">ÙƒØ§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
                <% categories.forEach(cat=> { %>
                  <option value="<%= cat.id %>" <%=filters.category_id==cat.id ? 'selected' : '' %>><%= cat.name_ar %>
                  </option>
                  <% }) %>
              </select>
            </div>
            <div class="col-lg-2 col-md-4">
              <label class="form-label small fw-bold text-muted"><i class="bi bi-toggle-on me-1"></i> Ø§Ù„Ø­Ø§Ù„Ø©</label>
              <select name="is_active" class="form-select bg-light">
                <option value="">Ø§Ù„ÙƒÙ„</option>
                <option value="1" <%=filters.is_active==='1' ? 'selected' : '' %>>Ù†Ø´Ø· (Ù…Ø¹Ø±ÙˆØ¶)</option>
                <option value="0" <%=filters.is_active==='0' ? 'selected' : '' %>>ØºÙŠØ± Ù†Ø´Ø· (Ù…Ø®ÙÙŠ)</option>
              </select>
            </div>
            <div class="col-lg-2 col-md-4">
              <div class="d-flex gap-2 w-100">
                <button type="submit" class="btn btn-primary flex-grow-1 fw-bold"><i class="bi bi-funnel-fill"></i>
                  ØªØ·Ø¨ÙŠÙ‚</button>
                <a href="/admin/products" class="btn btn-light border px-3" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ±"><i
                    class="bi bi-x-lg text-danger"></i></a>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Products Table -->
      <div class="card border-0 shadow-sm overflow-hidden border-top border-primary border-3">

        <!-- Table Toolbar -->
        <div class="card-header bg-white py-3 border-bottom d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-3">
            <div class="form-check m-0 ms-2">
              <input type="checkbox" class="form-check-input border-secondary" id="selectAll"
                style="transform: scale(1.1);">
            </div>
            <button id="bulkDeleteBtn"
              class="btn btn-danger btn-sm shadow-sm rounded-pill px-3 fw-bold animate__animated animate__fadeIn"
              style="display: none;">
              <i class="bi bi-trash-fill ms-1"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ (<span id="selectedCount">0</span>)
            </button>
          </div>
          <div>
            <span class="badge bg-light text-dark border px-3 py-2 rounded-pill fw-normal">
              <i class="bi bi-list-ul text-primary ms-1"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: <strong>
                <%= totalProducts %>
              </strong>
            </span>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 table-premium">
            <thead class="bg-light bg-opacity-75">
              <tr>
                <th style="width: 40px;" class="ps-4"></th>
                <th>Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¯Ù„ÙŠÙ„</th>
                <th>Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¯Ù„ÙŠÙ„</th>
                <th class="text-center">Ø§Ù„Ø³Ø¹Ø±</th>
                <th class="text-center">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªÙˆÙØ±</th>
                <th class="text-center">Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶</th>
                <th class="text-end pe-4" style="width: 80px;">Ø¥Ø¯Ø§Ø±Ø©</th>
              </tr>
            </thead>
            <tbody>
              <% products.forEach(function(p) { %>
                <tr>
                  <td class="ps-4">
                    <input type="checkbox" class="product-checkbox form-check-input border-secondary"
                      value="<%= p.id %>">
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-3">
                      <div class="product-img-wrapper shadow-sm">
                        <% if (p.image_path) { %>
                          <img src="/uploads/<%= p.image_path %>" alt="Product Image">
                          <% } else { %>
                            <i class="bi bi-image text-muted fs-4"></i>
                            <% } %>
                      </div>
                      <div>
                        <h6 class="fw-bold m-0 text-dark text-truncate" style="max-width: 200px;"
                          title="<%= p.name_ar %>">
                          <%= p.name_ar %>
                        </h6>
                        <div class="d-flex align-items-center gap-1 mt-1">
                          <% if (p.company) { %>
                            <span
                              class="badge bg-secondary bg-opacity-10 text-secondary border px-2 border-secondary border-opacity-25 rounded-pill"
                              style="font-size:0.6rem;">
                              <i class="bi bi-building"></i>
                              <%= p.company %>
                            </span>
                            <% } %>
                              <% if (p.colors || p.sizes) { %>
                                <span
                                  class="badge bg-info bg-opacity-10 text-info border px-2 border-info border-opacity-25 rounded-pill"
                                  style="font-size:0.6rem;">
                                  <i class="bi bi-sliders"></i> Ø®ÙŠØ§Ø±Ø§Øª
                                </span>
                                <% } %>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="text-dark fw-bold small">
                      <i class="bi bi-tag text-muted me-1 dropdown d-inline-block"></i>
                      <%= p.category_name || 'â€” Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ â€”' %>
                    </span>
                  </td>
                  <td class="text-center">
                    <div class="d-flex flex-column align-items-center">
                      <% if (p.discount_percent> 0) {
                        let discPrice = p.price - (p.price * (p.discount_percent/100));
                        %>
                        <span class="fw-bold text-success" style="font-size: 0.95rem;">
                          <%= Number(discPrice).toFixed(2) %> <small class="text-muted fw-normal">Ø¯.Ù„</small>
                        </span>
                        <span class="text-muted text-decoration-line-through" style="font-size: 0.70rem;">
                          <%= Number(p.price).toFixed(2) %>
                        </span>
                        <span class="badge bg-danger rounded-pill px-2 mt-1" style="font-size:0.6rem;">ğŸ”» <%=
                            p.discount_percent %>%</span>
                        <% } else { %>
                          <span class="fw-bold text-dark" style="font-size: 0.95rem;">
                            <%= Number(p.price).toFixed(2) %> <small class="text-muted fw-normal">Ø¯.Ù„</small>
                          </span>
                          <% } %>
                    </div>
                  </td>
                  <td class="text-center">
                    <% let stockBg='bg-success bg-opacity-10 text-success border-success' ; let
                      stockIcon='bi-check2-circle' ; let stockText='Ù…ØªÙˆÙØ±' ; if (p.stock <=0) {
                      stockBg='bg-danger bg-opacity-10 text-danger border-danger' ; stockIcon='bi-x-circle' ;
                      stockText='Ù†ÙØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' ; } else if (p.stock <=p.low_stock_alert) {
                      stockBg='bg-warning bg-opacity-10 text-dark border-warning' ; stockIcon='bi-exclamation-circle' ;
                      stockText='Ø£ÙˆØ´Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙØ§Ø¯' ; } %>
                      <div class="d-flex flex-column align-items-center gap-1">
                        <span class="badge <%= stockBg %> border rounded-pill px-3 py-1 fs-6 shadow-sm font-monospace"
                          style="min-width: 50px;">
                          <%= p.stock %>
                        </span>
                        <small
                          class="<%= stockBg.replace('bg-opacity-10', '').replace('border-', 'text-!').split(' ')[1] %> fw-bold"
                          style="font-size: 0.65rem;">
                          <i class="bi <%= stockIcon %>"></i>
                          <%= stockText %>
                        </small>
                      </div>
                  </td>
                  <td class="text-center">
                    <% if (p.is_active) { %>
                      <span class="badge bg-success rounded-pill px-3 py-2 shadow-sm"><i
                          class="bi bi-eye-fill ms-1"></i> Ù…Ø¹Ø±ÙˆØ¶</span>
                      <% } else { %>
                        <span class="badge bg-secondary rounded-pill px-3 py-2 shadow-sm"><i
                            class="bi bi-eye-slash-fill ms-1"></i> Ù…Ø³ÙˆØ¯Ø© Ù…Ø®ÙÙŠØ©</span>
                        <% } %>
                  </td>
                  <td class="text-end pe-4">
                    <div class="dropdown">
                      <button class="btn btn-light btn-sm rounded-circle border shadow-sm" type="button"
                        data-bs-toggle="dropdown" style="width: 36px; height: 36px;">
                        <i class="bi bi-three-dots-vertical"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end shadow border-0 p-1 rounded-3">
                        <li>
                          <a class="dropdown-item py-2 px-3 rounded text-dark fw-bold"
                            href="/admin/products/edit/<%= p.id %>">
                            <i class="bi bi-pencil-square ms-2 text-primary"></i> <span class="pt-1">ØªØ¹Ø¯ÙŠÙ„
                              Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                          </a>
                        </li>
                        <li>
                          <hr class="dropdown-divider my-1">
                        </li>
                        <li>
                          <form action="/admin/products/delete/<%= p.id %>" method="POST"
                            onsubmit="return confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù†ØªØ¬ (Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡)ØŸ')">
                            <button type="submit"
                              class="dropdown-item py-2 px-3 rounded text-danger fw-bold hover-bg-danger">
                              <i class="bi bi-trash-fill ms-2"></i> <span class="pt-1">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</span>
                            </button>
                          </form>
                        </li>
                      </ul>
                    </div>
                  </td>
                </tr>
                <% }); %>
                  <% if (!products.length) { %>
                    <tr>
                      <td colspan="7" class="text-center py-5">
                        <div class="text-muted">
                          <div
                            class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                            style="width: 80px; height: 80px;">
                            <i class="bi bi-inbox fs-1 text-secondary opacity-50"></i>
                          </div>
                          <h6 class="fw-bold">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©</h6>
                          <p class="mb-0 small">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø« Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø§Ù„Ù…Ø®Ø²Ù†
                            Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                        </div>
                      </td>
                    </tr>
                    <% } %>
            </tbody>
          </table>
        </div>

        <!-- Pagination Footer -->
        <% if (totalPages> 1) { %>
          <div
            class="card-footer bg-white border-top py-4 d-flex justify-content-between align-items-center border-0 px-4">
            <div class="text-muted small fw-bold">
              Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© <span class="badge bg-light text-dark border px-2 mx-1">
                <%= currentPage %>
              </span> Ù…Ù† <span class="badge bg-light text-dark border px-2 mx-1">
                <%= totalPages %>
              </span>
            </div>
            <nav>
              <ul class="pagination pagination-sm m-0 gap-2">
                <li class="page-item <%= currentPage <= 1 ? 'disabled' : '' %>">
                  <a class="page-link rounded-pill px-3 py-2 fw-bold shadow-sm <%= currentPage <= 1 ? 'bg-light text-muted border-0' : 'text-primary border-primary' %>"
                    href="?<%= queryString ? queryString + '&' : '' %>page=<%= currentPage - 1 %>">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
                </li>

                <% let startPage=Math.max(1, currentPage - 2); let endPage=Math.min(totalPages, startPage + 4); if
                  (endPage - startPage < 4) startPage=Math.max(1, endPage - 4); %>

                  <% for(let i=startPage; i <=endPage; i++) { %>
                    <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                      <a class="page-link rounded-circle fw-bold shadow-sm d-flex align-items-center justify-content-center border-0"
                        style="width: 36px; height: 36px; <%= i === currentPage ? 'background-color: var(--bs-primary);' : 'color: #333; background-color: #f8f9fa;' %>"
                        href="?<%= queryString ? queryString + '&' : '' %>page=<%= i %>">
                        <%= i %>
                      </a>
                    </li>
                    <% } %>

                      <li class="page-item <%= currentPage >= totalPages ? 'disabled' : '' %>">
                        <a class="page-link rounded-pill px-3 py-2 fw-bold shadow-sm border-0 <%= currentPage >= totalPages ? 'bg-light text-muted' : 'bg-primary text-white' %>"
                          href="?<%= queryString ? queryString + '&' : '' %>page=<%= currentPage + 1 %>">Ø§Ù„ØªØ§Ù„ÙŠ</a>
                      </li>
              </ul>
            </nav>
          </div>
          <% } %>
      </div>
    </div>

    <!-- Import Modal (Premium Style) -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
          <div class="modal-header border-0 bg-light pb-4 pt-4 px-4 position-relative">
            <div class="position-absolute top-0 start-0 w-100 h-100 bg-success bg-opacity-10"></div>
            <div class="position-relative z-1 d-flex align-items-center w-100">
              <div class="bg-white rounded-circle d-flex align-items-center justify-content-center shadow-sm me-3"
                style="width: 48px; height: 48px;">
                <i class="bi bi-file-earmark-excel-fill text-success fs-3"></i>
              </div>
              <div>
                <h5 class="fw-bold m-0 text-dark">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©</h5>
                <p class="small text-muted mb-0 mt-1">Ø¹Ø¨Ø± Ù…Ù„ÙØ§Øª Ø¨ØµÙŠØºØ© CSV Ø£Ùˆ Excel (WooCommerce)</p>
              </div>
              <button type="button" class="btn-close ms-auto align-self-start" data-bs-dismiss="modal"
                aria-label="Close"></button>
            </div>
          </div>

          <form id="importForm" action="/admin/products/import" method="post" enctype="multipart/form-data">
            <div class="modal-body p-4 bg-white">
              <p class="small text-muted mb-4 border-start border-3 border-info ps-3 py-1 bg-light rounded-end">
                Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØªØ¹Ø±Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© Ù…Ø«Ù„: Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ÙˆØµÙØŒ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠØŒ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŒ ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø®Ø§ØµØ©
                Ø¨Ø§Ù„ØµÙˆØ±.
              </p>

              <div id="importAlert" style="display: none;" class="mb-3 rounded-3 shadow-none border"></div>

              <div class="mb-4">
                <label class="form-label fw-bold text-dark mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ <span
                    class="text-danger">*</span></label>
                <div class="input-group">
                  <input type="file" class="form-control form-control-lg bg-light fs-6" name="csv_file"
                    accept=".csv, .xlsx, .xls" required>
                </div>
              </div>

              <div id="importProgressBox" style="display: none;" class="mt-4 p-3 border rounded-3 bg-light">
                <div class="d-flex justify-content-between mb-2">
                  <span id="importProgressText" class="small fw-bold text-primary"><i
                      class="spinner-border spinner-border-sm me-1"></i> ÙŠØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ÙˆÙ…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±...</span>
                </div>
                <div class="progress" style="height: 10px; border-radius: 5px;">
                  <div id="importProgressBg" class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                    role="progressbar" style="width: 20%;"></div>
                </div>
                <p class="small text-muted mt-2 mb-0 text-center" style="font-size:0.7rem;">Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¯Ù‚Ø§Ø¦Ù‚
                  Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙˆØ³Ø±Ø¹Ø© Ø§ØªØµØ§Ù„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ù…ØµØ§Ø¯Ø± Ø§Ù„ØµÙˆØ±.</p>
              </div>
            </div>

            <div class="modal-footer border-0 p-4 pt-0 bg-white">
              <div class="row w-100 g-2 m-0">
                <div class="col-6 p-0 pe-1">
                  <button type="button" class="btn btn-light w-100 border text-dark fw-bold py-2"
                    data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ù…Ø±</button>
                </div>
                <div class="col-6 p-0 ps-1">
                  <button type="submit" id="importSubmitBtn" class="btn btn-success w-100 fw-bold py-2">
                    <i class="bi bi-cloud-upload-fill me-1"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <style>
      .hover-bg-danger:hover {
        background-color: #dc3545 !important;
        color: white !important;
      }

      .product-checkbox {
        cursor: pointer;
      }
    </style>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Import Logic
        const importForm = document.getElementById('importForm');
        if (importForm) {
          importForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(importForm);
            const btn = document.getElementById('importSubmitBtn');
            const alertBox = document.getElementById('importAlert');
            const progressBox = document.getElementById('importProgressBox');
            const progressBg = document.getElementById('importProgressBg');
            const progressText = document.getElementById('importProgressText');

            alertBox.style.display = 'none';
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...';
            progressBox.style.display = 'block';
            progressBg.style.width = '60%';
            progressBg.className = 'progress-bar progress-bar-striped progress-bar-animated bg-primary';
            progressText.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i> Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...';

            try {
              const res = await fetch('/admin/products/import', { method: 'POST', body: formData });
              const data = await res.json();
              progressBg.style.width = '100%';

              if (data.success) {
                progressBg.className = 'progress-bar bg-success';
                progressText.innerHTML = '<i class="bi bi-check2-all me-1"></i> Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!';
                alertBox.className = 'alert alert-success small py-3 fw-bold';
                alertBox.innerHTML = '<i class="bi bi-check-circle-fill ms-2 fs-5"></i> ' + data.message;
                alertBox.style.display = 'block';
                setTimeout(() => location.reload(), 2000);
              } else {
                throw new Error(data.message || 'ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
              }
            } catch (err) {
              progressBox.style.display = 'none';
              alertBox.className = 'alert alert-danger small py-3 fw-bold';
              alertBox.innerHTML = '<i class="bi bi-exclamation-triangle-fill ms-2 fs-5"></i> Ø®Ø·Ø£: ' + err.message;
              alertBox.style.display = 'block';
            } finally {
              btn.disabled = false;
              btn.innerHTML = '<i class="bi bi-cloud-upload-fill me-1"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©';
            }
          });
        }

        // Bulk Delete Logic
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.product-checkbox');
        const bulkBtn = document.getElementById('bulkDeleteBtn');
        const countSpan = document.getElementById('selectedCount');

        function updateUI() {
          const selected = Array.from(checkboxes).filter(cb => cb.checked);
          bulkBtn.style.display = selected.length > 0 ? 'inline-block' : 'none';
          countSpan.innerText = selected.length;
        }

        if (selectAll) {
          selectAll.addEventListener('change', () => {
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateUI();
          });
        }

        checkboxes.forEach(cb => cb.addEventListener('change', updateUI));

        if (bulkBtn) {
          bulkBtn.addEventListener('click', async () => {
            const ids = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            if (!confirm(`ØªØ­Ø°ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${ids.length} Ù…Ù†ØªØ¬ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) return;

            bulkBtn.disabled = true;
            bulkBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';

            try {
              const res = await fetch('/admin/products/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids })
              });
              const data = await res.json();
              if (data.success) {
                location.reload();
              } else {
                alert('Ø®Ø·Ø£: ' + data.message);
                bulkBtn.disabled = false;
                bulkBtn.innerHTML = '<i class="bi bi-trash-fill ms-1"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ (' + ids.length + ')';
              }
            } catch (err) {
              alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙ†ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.');
              bulkBtn.disabled = false;
              bulkBtn.innerHTML = '<i class="bi bi-trash-fill ms-1"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ (' + ids.length + ')';
            }
          });
        }
      });
    </script>

    <%- include('../partials/scripts') %>