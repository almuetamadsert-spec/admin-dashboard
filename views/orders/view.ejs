<%- include('../partials/head', { title: 'ุชูุงุตูู ูุงุณุชุนุฑุงุถ ุงูุทูุจ' }) %>
  <%- include('../partials/sidebar', { adminUsername }) %>

    <style>
      .invoice-card {
        border-radius: 1.25rem;
        border: none;
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.05);
      }

      .invoice-header {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        color: white;
        border-radius: 1.25rem 1.25rem 0 0;
        padding: 2.5rem;
      }

      .table-premium-items th {
        background-color: #f8fafc;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        color: #64748b;
        padding: 1rem;
        border-bottom: 2px solid #e2e8f0;
      }

      .table-premium-items td {
        padding: 1.25rem 1rem;
        vertical-align: middle;
      }

      .status-badge-lg {
        padding: 0.6rem 1.25rem;
        border-radius: 50rem;
        font-weight: 700;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .info-label {
        color: #64748b;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 0.25rem;
        display: block;
      }

      .info-value {
        color: #1e293b;
        font-weight: 700;
        font-size: 0.95rem;
      }

      @media print {

        .sidebar,
        .btn-print-hide,
        .status-update-card {
          display: none !important;
        }

        main {
          margin: 0 !important;
          padding: 0 !important;
        }

        .invoice-card {
          box-shadow: none !important;
          border: 1px solid #e2e8f0 !important;
        }
      }
    </style>

    <div class="container-fluid py-4 px-4 pb-5">
      <!-- Action Header -->
      <div class="d-flex justify-content-between align-items-center mb-4 btn-print-hide">
        <a href="/admin/orders" class="btn btn-light border shadow-sm fw-bold">
          <i class="bi bi-arrow-right-circle ms-1"></i> ุงูุนูุฏุฉ ููุณุฌู
        </a>
        <div class="d-flex gap-2">
          <button onclick="window.print()" class="btn btn-dark shadow-sm fw-bold">
            <i class="bi bi-printer-fill ms-1"></i> ุทุจุงุนุฉ ุงููุงุชูุฑุฉ
          </button>
          <a href="/admin/orders/edit/<%= order.id %>" class="btn btn-primary shadow-sm fw-bold">
            <i class="bi bi-pencil-square ms-1"></i> ุชุนุฏูู ุงูุทูุจ
          </a>
        </div>
      </div>

      <div class="invoice-card bg-white overflow-hidden mb-4">
        <!-- Invoice Header -->
        <div class="invoice-header d-flex justify-content-between align-items-start">
          <div>
            <h2 class="fw-bold mb-1">ูุงุชูุฑุฉ ุทูุจ ุจูุน</h2>
            <p class="mb-0 opacity-75">ุฑูู ุงููุฑุฌุน ุงูููุญุฏ: #<%= order.order_number %>
            </p>
          </div>
          <div class="text-start">
            <% let badgeClass='bg-warning text-dark' ; let statusLabel=STATUS_LABELS[order.status] || order.status;
              if(order.status==='delivered' ) badgeClass='bg-success text-white' ; else if(order.status==='cancelled' ||
              order.status==='customer_refused' ) badgeClass='bg-danger text-white' ; else if(order.status==='shipped' )
              badgeClass='bg-info text-white' ; else if(order.status==='confirmed' ) badgeClass='bg-primary text-white'
              ; %>
              <div class="status-badge-lg <%= badgeClass %> shadow-lg mb-3">
                <i class="bi bi-patch-check-fill"></i>
                <%= statusLabel %>
              </div>
              <div class="small opacity-75">ุชุงุฑูุฎ ุงูุชูุซูู: <%= new Date(order.created_at).toLocaleDateString('ar-LY', {
                  year: 'numeric' , month: 'long' , day: 'numeric' , hour: '2-digit' , minute: '2-digit' }) %>
              </div>
          </div>
        </div>

        <div class="card-body p-5">
          <div class="row mb-5 g-4">
            <!-- Customer Details -->
            <div class="col-md-4">
              <div class="p-4 rounded-4 bg-light h-100">
                <h6 class="fw-bold mb-3 d-flex align-items-center gap-2">
                  <i class="bi bi-person-circle text-primary"></i> ุจูุงูุงุช ุงูุนููู
                </h6>
                <div class="mb-3">
                  <span class="info-label">ุงูุงุณู ุงููุงูู</span>
                  <span class="info-value">
                    <%= order.customer_name || 'โ' %>
                  </span>
                </div>
                <div class="mb-3">
                  <span class="info-label">ุฑูู ุงููุงุชู</span>
                  <span class="info-value font-monospace" dir="ltr">
                    <%= order.customer_phone || 'โ' %>
                  </span>
                </div>
                <% if (order.customer_phone_alt || order.CUSTOMER_PHONE_ALT) { %>
                  <div class="mb-3">
                    <span class="info-label">ูุงุชู ุจุฏูู</span>
                    <span class="info-value font-monospace" dir="ltr">
                      <%= order.customer_phone_alt || order.CUSTOMER_PHONE_ALT %>
                    </span>
                  </div>
                  <% } %>
                    <div>
                      <span class="info-label">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</span>
                      <span class="info-value">
                        <%= order.customer_email || 'โ' %>
                      </span>
                    </div>
              </div>
            </div>

            <!-- Shipping Details -->
            <div class="col-md-4">
              <div class="p-4 rounded-4 bg-light h-100 border-start border-info border-4">
                <h6 class="fw-bold mb-3 d-flex align-items-center gap-2">
                  <i class="bi bi-geo-alt-fill text-info"></i> ูุฌูุฉ ุงูุชูุตูู
                </h6>
                <div class="mb-3">
                  <span class="info-label">ุงููุฏููุฉ / ุงูููุทูุฉ</span>
                  <span class="info-value">
                    <%= (typeof cityName !=='undefined' && cityName) ? cityName : (order.city_name || 'โ' ) %>
                  </span>
                </div>
                <div>
                  <span class="info-label">ุงูุนููุงู ุงูุชูุตููู</span>
                  <span class="info-value">
                    <%= order.customer_address || 'โ' %>
                  </span>
                </div>
              </div>
            </div>

            <!-- Assignment Details -->
            <div class="col-md-4">
              <div class="p-4 rounded-4 bg-light h-100 border-start border-warning border-4">
                <h6 class="fw-bold mb-3 d-flex align-items-center gap-2">
                  <i class="bi bi-shop text-warning"></i> ุชูููุฐ ุงูุทูุจ
                </h6>
                <% if (typeof merchant !=='undefined' && merchant) { %>
                  <div class="mb-3">
                    <span class="info-label">ุงูุชุงุฌุฑ ุงููุณูุฏ ุฅููู</span>
                    <span class="info-value">
                      <%= merchant.store_name || merchant.name %>
                    </span>
                  </div>
                  <div>
                    <span class="info-label">ุชูุงุตู ุงูุชุงุฌุฑ</span>
                    <span class="info-value small text-muted">
                      <%= merchant.email %>
                    </span>
                  </div>
                  <% } else { %>
                    <div class="d-flex align-items-center justify-content-center h-75 text-muted small">
                      <i class="bi bi-shield-lock ms-2"></i> ุชูููุฐ ุจูุงุณุทุฉ ุงูุฅุฏุงุฑุฉ ุงููุฑูุฒูุฉ
                    </div>
                    <% } %>
              </div>
            </div>
          </div>

          <!-- Items Table -->
          <div class="table-responsive mb-5">
            <table class="table table-premium-items align-middle">
              <thead>
                <tr>
                  <th class="ps-4">ุงูููุชุฌ ูุงููุตู</th>
                  <th class="text-center">ุณุนุฑ ุงููุญุฏุฉ</th>
                  <th class="text-center">ุงููููุฉ</th>
                  <th class="text-end pe-4">ุงูุฅุฌูุงูู ุงููุฑุนู</th>
                </tr>
              </thead>
              <tbody>
                <% items.forEach(function(i) { %>
                  <tr>
                    <td class="ps-4">
                      <div class="d-flex align-items-center gap-3">
                        <% var imgSrc=i.image_url || (i.image_path ? ('/uploads/' + (i.image_path + ''
                          ).replace(/\\/g, '/' ).replace(/^\/+/, '' )) : '' ); %>
                          <% if (imgSrc) { %>
                            <img src="<%= imgSrc %>" alt="" class="rounded-3 shadow-sm border"
                              style="width:54px;height:54px;object-fit:cover">
                            <% } else { %>
                              <div
                                class="rounded-3 bg-light border d-flex align-items-center justify-content-center text-muted"
                                style="width:54px;height:54px;">
                                <i class="bi bi-image"></i>
                              </div>
                              <% } %>
                                <div>
                                  <span class="fw-bold text-dark d-block">
                                    <%= i.product_name %>
                                  </span>
                                  <small class="text-muted">
                                    <%= i.sku || 'SKU: ' + i.product_id %>
                                  </small>
                                </div>
                      </div>
                    </td>
                    <td class="text-center fw-bold text-dark">
                      <%= Number(i.unit_price).toFixed(2) %> <small class="text-muted">ุฏ.ู</small>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-light text-dark border px-3 py-2 rounded-3 fw-bold">x <%= i.quantity %>
                          </span>
                    </td>
                    <td class="text-end pe-4 fw-bold text-primary fs-6">
                      <%= Number(i.total_price).toFixed(2) %> <small class="text-muted">ุฏ.ู</small>
                    </td>
                  </tr>
                  <% }); %>
              </tbody>
            </table>
          </div>

          <!-- Totals and Notes -->
          <div class="row align-items-start g-4">
            <div class="col-md-7">
              <% if (order.notes) { %>
                <div class="p-4 rounded-4 bg-light border-dashed border-2">
                  <span class="info-label text-muted d-flex align-items-center gap-2 mb-2">
                    <i class="bi bi-chat-left-text"></i> ููุงุญุธุงุช ุฅุถุงููุฉ ุนูู ุงูุทูุจ
                  </span>
                  <p class="mb-0 text-dark small fw-bold" style="line-height: 1.6;">
                    <%= order.notes %>
                  </p>
                </div>
                <% } %>
            </div>
            <div class="col-md-5">
              <div class="card border-0 bg-primary bg-opacity-10 p-4 rounded-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-primary fw-bold">ุฅุฌูุงูู ุงููุดุชุฑูุงุช</span>
                  <span class="text-dark fw-bold">
                    <%= Number(order.total_amount).toFixed(2) %> ุฏ.ู
                  </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-primary fw-bold">ุฑุณูู ุงูุชูุตูู</span>
                  <span class="text-dark fw-bold">0.00 ุฏ.ู</span>
                </div>
                <hr class="my-3 opacity-25 border-primary">
                <div class="d-flex justify-content-between align-items-center">
                  <h4 class="fw-bold text-primary mb-0">ุงูุฅุฌูุงูู ุงูููู</h4>
                  <h4
                    class="fw-bold text-dark mb-0 font-monospace badge bg-white text-primary p-3 fs-3 border border-primary border-opacity-25 shadow-sm">
                    <%= Number(order.total_amount).toFixed(2) %> <span class="fs-6 fw-normal">ุฏ.ู</span>
                  </h4>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card-footer bg-light p-4 text-center border-0 small text-muted">
          <i class="bi bi-info-circle ms-1"></i> ูุฐู ุงููุซููุฉ ุชู ุฅูุดุงุคูุง ูุชูุซูููุง ุฅููุชุฑูููุงู ุนุจุฑ ูุฑูุฒ ุนูููุงุช ุงููุจูุนุงุช.
        </div>
      </div>

      <!-- Status Update Form (Hidden in print) -->
      <div class="card invoice-card status-update-card btn-print-hide">
        <div class="card-body p-4">
          <h6 class="fw-bold mb-4 d-flex align-items-center gap-2">
            <i class="bi bi-ui-checks text-primary"></i> ุชุญุฏูุซ ุงูุญุงูุฉ ุงูุฅุฑุณุงููุฉ
          </h6>
          <form method="post" action="/admin/orders/status/<%= order.id %>" class="row g-3 align-items-end">
            <div class="col-md-8">
              <label class="form-label small fw-bold text-muted">ุงุฎุชุฑ ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ ููุฒุงููุชูุง ูุน ุงูุนููู ูุงูุชุงุฌุฑ</label>
              <select name="status" class="form-select form-select-lg fw-bold border-2">
                <option value="pending" <%=order.status==='pending' ? 'selected' : '' %>>๐ก ููุฏ ุงูุงูุชุธุงุฑ</option>
                <option value="confirmed" <%=order.status==='confirmed' ? 'selected' : '' %>>๐ต ูุคูุฏ / ุฌุงุฑู ุงูุชุฌููุฒ
                </option>
                <option value="shipped" <%=order.status==='shipped' ? 'selected' : '' %>>๐ ุชู ุงูุดุญู / ุงูุชุณููู ููููุฏูุจ
                </option>
                <option value="delivered" <%=order.status==='delivered' ? 'selected' : '' %>>๐ข ุชู ุงูุชูุตูู ุจูุฌุงุญ
                </option>
                <option value="cancelled" <%=order.status==='cancelled' ? 'selected' : '' %>>๐ด ููุบู</option>
                <option value="customer_refused" <%=order.status==='customer_refused' ? 'selected' : '' %>>โ ุฑูุถ
                  ุงูุงุณุชูุงู</option>
              </select>
            </div>
            <div class="col-md-4">
              <button type="submit" class="btn btn-primary btn-lg w-100 fw-bold shadow-sm">
                ุชุญุฏูุซ ุงูุญุงูุฉ ุงูุขู <i class="bi bi-arrow-left-circle me-1"></i>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <%- include('../partials/scripts') %>