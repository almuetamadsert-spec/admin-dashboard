<%- include('../partials/head', { title: 'الطلبات' }) %>
  <%- include('../partials/sidebar', { adminUsername }) %>

    <h4 class="mb-4">الطلبات</h4>
    <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
      <a href="/admin/orders/new" class="btn btn-primary"><i class="bi bi-plus"></i> إنشاء طلب</a>
      <a href="/admin/orders/export<%= queryString ? '?' + queryString : '' %>" class="btn btn-outline-success"><i
          class="bi bi-download"></i> تصدير CSV</a>
    </div>

    <form method="get" action="/admin/orders" class="card p-3 mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-2">
          <label class="form-label small">بحث (رقم الطلب / الهاتف / العميل)</label>
          <input type="text" name="q" class="form-control form-control-sm"
            value="<%= filters && filters.q ? filters.q : '' %>" placeholder="بحث...">
        </div>
        <div class="col-md-2">
          <label class="form-label small">الحالة</label>
          <select name="status" class="form-select form-select-sm">
            <option value="">— الكل —</option>
            <option value="pending" <%=filters && filters.status==='pending' ? 'selected' : '' %>>قيد الانتظار</option>
            <option value="confirmed" <%=filters && filters.status==='confirmed' ? 'selected' : '' %>>مؤكد</option>
            <option value="shipped" <%=filters && filters.status==='shipped' ? 'selected' : '' %>>تم الشحن</option>
            <option value="delivered" <%=filters && filters.status==='delivered' ? 'selected' : '' %>>تم التوصيل
            </option>
            <option value="cancelled" <%=filters && filters.status==='cancelled' ? 'selected' : '' %>>ملغي</option>
            <option value="customer_refused" <%=filters && filters.status==='customer_refused' ? 'selected' : '' %>
              >العميل رفض</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small">من تاريخ</label>
          <input type="date" name="date_from" class="form-control form-control-sm"
            value="<%= filters && filters.date_from ? filters.date_from : '' %>" dir="ltr" title="يوم / شهر / سنة">
        </div>
        <div class="col-md-2">
          <label class="form-label small">إلى تاريخ</label>
          <input type="date" name="date_to" class="form-control form-control-sm"
            value="<%= filters && filters.date_to ? filters.date_to : '' %>" dir="ltr" title="يوم / شهر / سنة">
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary btn-sm w-100">بحث</button>
        </div>
      </div>
    </form>

    <div class="card">
      <div class="card-body py-3 d-flex flex-wrap align-items-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <select class="form-select form-select-sm" id="orderBulkAction" style="width:auto;min-width:140px">
            <option value="">تنفيذ الأمر</option>
            <option value="view">عرض</option>
            <option value="edit">تعديل</option>
            <option value="delete">حذف</option>
            <option value="status">تغيير الحالة</option>
            <option value="print">طباعة</option>
          </select>
          <select class="form-select form-select-sm" id="orderBulkStatus"
            style="width:auto;min-width:130px;display:none">
            <option value="pending">قيد الانتظار</option>
            <option value="confirmed">مؤكد</option>
            <option value="shipped">تم الشحن</option>
            <option value="delivered">تم التوصيل</option>
            <option value="cancelled">ملغي</option>
            <option value="customer_refused">العميل رفض</option>
          </select>
          <button type="button" class="btn btn-sm btn-primary flex-shrink-0" id="btnOrderApply">تطبيق</button>
        </div>
        <span class="small text-muted">عرض <%= orders.length %> من <%= total %> طلب — الصفحة <%= page %> من <%=
                  totalPages %></span>
      </div>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th class="text-end" style="width:2.5rem">
                <input type="checkbox" class="form-check-input" id="orderSelectAll" title="تحديد الكل">
              </th>
              <th class="text-start">
                <span class="d-inline-flex align-items-center gap-1">الطلب <i
                    class="bi bi-arrow-down-up small text-muted"></i></span>
              </th>
              <th>المبلغ</th>
              <th>الحالة</th>
              <th>التاريخ</th>
            </tr>
          </thead>
          <tbody>
            <% orders.forEach(function(o) { %>
              <tr>
                <td class="text-end">
                  <input type="checkbox" class="form-check-input order-row-cb" name="order_ids" value="<%= o.id %>">
                </td>
                <td class="text-start">
                  <a href="/admin/orders/view/<%= o.id %>"
                    class="text-primary text-decoration-none d-inline-flex align-items-center gap-1" title="عرض">
                    <i class="bi bi-eye"></i>
                    <span>#<%= o.order_number %>
                        <%= o.display_name || '—' %></span>
                  </a>
                </td>
                <td>
                  <%= Number(o.total_amount).toFixed(2) %> د.ل
                </td>
                <td>
                  <span
                    class="badge bg-<%= o.status === 'delivered' ? 'success' : (o.status === 'cancelled' || o.status === 'customer_refused') ? 'danger' : o.status === 'shipped' ? 'info' : o.status === 'confirmed' ? 'primary' : 'warning' %>">
                    <%= STATUS_LABELS[o.status] || o.status %>
                  </span>
                </td>
                <td>
                  <% var _d=new Date(o.created_at); var _dd=String(_d.getDate()).padStart(2,'0'); var
                    _mm=String(_d.getMonth()+1).padStart(2,'0'); var _yy=_d.getFullYear(); %>
                    <%= _dd %>/<%= _mm %>/<%= _yy %>
                </td>
              </tr>
              <% }); %>
                <% if (!orders.length) { %>
                  <tr>
                    <td colspan="5" class="text-center text-muted">لا توجد طلبات</td>
                  </tr>
                  <% } %>
          </tbody>
        </table>
      </div>
      <% if (totalPages> 1) { %>
        <div class="card-footer py-2">
          <nav>
            <ul class="pagination pagination-sm mb-0 justify-content-center flex-wrap">
              <li class="page-item <%= page <= 1 ? 'disabled' : '' %>">
                <% if (page <=1) { %><span class="page-link">السابق</span>
                  <% } else { %><a class="page-link"
                      href="?<%= queryString ? queryString + '&' : '' %>page=<%= page - 1 %>">السابق</a>
                    <% } %>
              </li>
              <li class="page-item disabled"><span class="page-link">ص <%= page %> من <%= totalPages %></span></li>
              <li class="page-item <%= page >= totalPages ? 'disabled' : '' %>">
                <% if (page>= totalPages) { %><span class="page-link">التالي</span>
                  <% } else { %><a class="page-link"
                      href="?<%= queryString ? queryString + '&' : '' %>page=<%= page + 1 %>">التالي</a>
                    <% } %>
              </li>
            </ul>
          </nav>
        </div>
        <% } %>
    </div>

    <script>
      (function () {
        var base = '/admin/orders';
        var bulkAction = document.getElementById('orderBulkAction');
        var bulkStatus = document.getElementById('orderBulkStatus');
        var btnApply = document.getElementById('btnOrderApply');
        var selectAll = document.getElementById('orderSelectAll');

        if (bulkAction) {
          bulkAction.addEventListener('change', function () {
            if (bulkStatus) bulkStatus.style.display = (this.value === 'status') ? 'inline-block' : 'none';
          });
        }
        if (selectAll) {
          selectAll.addEventListener('change', function () {
            document.querySelectorAll('.order-row-cb').forEach(function (cb) { cb.checked = selectAll.checked; });
          });
        }
        if (btnApply) {
          btnApply.addEventListener('click', function () {
            var ids = [];
            document.querySelectorAll('.order-row-cb:checked').forEach(function (cb) { ids.push(cb.value); });
            var action = bulkAction && bulkAction.value ? bulkAction.value : '';
            if (!action) {
              alert('اختر الإجراء من قائمة «تنفيذ الأمر»');
              return;
            }
            if (ids.length === 0) {
              alert('حدد طلباً واحداً على الأقل');
              return;
            }
            var id = ids[0];
            if (action === 'view') {
              window.location.href = base + '/view/' + id;
              return;
            }
            if (action === 'edit') {
              window.location.href = base + '/edit/' + id;
              return;
            }
            if (action === 'print') {
              var w = window.open(base + '/view/' + id, '_blank', 'width=900,height=700');
              if (w) w.onload = function () { w.print(); };
              return;
            }
            if (action === 'delete') {
              if (!confirm('حذف ' + (ids.length > 1 ? ids.length + ' طلبات؟' : 'هذا الطلب؟'))) return;
              if (ids.length === 1) {
                var f = document.createElement('form');
                f.method = 'post';
                f.action = base + '/delete/' + id;
                document.body.appendChild(f);
                f.submit();
              } else {
                var f = document.createElement('form');
                f.method = 'post';
                f.action = base + '/bulk-delete';
                var inp = document.createElement('input');
                inp.type = 'hidden';
                inp.name = 'ids';
                inp.value = ids.join(',');
                f.appendChild(inp);
                document.body.appendChild(f);
                f.submit();
              }
              return;
            }
            if (action === 'status') {
              var newStatus = bulkStatus && bulkStatus.value ? bulkStatus.value : '';
              if (!newStatus) {
                alert('اختر الحالة الجديدة');
                return;
              }
              if (ids.length === 1) {
                var f = document.createElement('form');
                f.method = 'post';
                f.action = base + '/status/' + id;
                var inp = document.createElement('input');
                inp.type = 'hidden';
                inp.name = 'status';
                inp.value = newStatus;
                f.appendChild(inp);
                document.body.appendChild(f);
                f.submit();
              } else {
                var f = document.createElement('form');
                f.method = 'post';
                f.action = base + '/bulk-status';
                var s = document.createElement('input');
                s.type = 'hidden';
                s.name = 'status';
                s.value = newStatus;
                f.appendChild(s);
                var inp = document.createElement('input');
                inp.type = 'hidden';
                inp.name = 'ids';
                inp.value = ids.join(',');
                f.appendChild(inp);
                document.body.appendChild(f);
                f.submit();
              }
            }
          });
        }
      })();
    </script>
    <%- include('../partials/scripts') %>